<!DOCTYPE html>
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
      <title>Consolidated TEXT: 32016R0799 — EN — 21.08.2023</title>
      
   
</head>
<body>
<h1>Appendix 11: COMMON SECURITY MECHANISMS</h1>

<nav><h2>Table of Contents</h2><ol><li><a href="#preamble">PREAMBLE</a></li><li><a href="#first-generation-tachograph-system">FIRST-GENERATION TACHOGRAPH SYSTEM</a></li><li><a href="#introduction">INTRODUCTION</a></li><li><a href="#references">References</a></li><li><a href="#notations-and-abbreviated-terms">Notations and abbreviated terms</a></li><li><a href="#cryptographic-systems-and-algorithms">CRYPTOGRAPHIC SYSTEMS AND ALGORITHMS</a></li><li><a href="#cryptographic-systems">Cryptographic systems</a></li><li><a href="#cryptographic-algorithms">Cryptographic algorithms</a></li><li><a href="#rsa-algorithm">RSA algorithm</a></li><li><a href="#hash-algorithm">Hash algorithm</a></li><li><a href="#data-encryption-algorithm">Data Encryption Algorithm</a></li><li><a href="#keys-and-certificates">KEYS AND CERTIFICATES</a></li><li><a href="#keys-generation-and-distribution">Keys generation and distribution</a></li><li><a href="#rsa-keys-generation-and-distribution">RSA Keys generation and distribution</a></li><li><a href="#rsa-test-keys">RSA Test keys</a></li><li><a href="#motion-sensor-keys">Motion sensor keys</a></li><li><a href="#t-des-session-keys-generation-and-distribution">T-DES session keys generation and distribution</a></li><li><a href="#keys">Keys</a></li><li><a href="#certificates">Certificates</a></li><li><a href="#certificates-content">Certificates content</a></li><li><a href="#certificates-issued">Certificates issued</a></li><li><a href="#certificate-verification-and-unwrapping">Certificate verification and unwrapping</a></li><li><a href="#mutual-authentication-mechanism">MUTUAL AUTHENTICATION MECHANISM</a></li><li><a href="#vu-cards-data-transfer-confidentiality-integrity-a">VU-CARDS DATA TRANSFER CONFIDENTIALITY, INTEGRITY AND AUTHENTICATION MECHANISMS</a></li><li><a href="#secure-messaging">Secure Messaging</a></li><li><a href="#treatment-of-secure-messaging-errors">Treatment of Secure Messaging errors</a></li><li><a href="#algorithm-to-compute-cryptographic-checksums">Algorithm to compute Cryptographic Checksums</a></li><li><a href="#algorithm-to-compute-cryptograms-for-confidentiali">Algorithm to compute cryptograms for confidentiality DOs</a></li><li><a href="#data-download-digital-signature-mechanisms">DATA DOWNLOAD DIGITAL SIGNATURE MECHANISMS</a></li><li><a href="#signature-generation">Signature generation</a></li><li><a href="#signature-verification">Signature verification</a></li><li><a href="#second-generation-tachograph-system">SECOND-GENERATION TACHOGRAPH SYSTEM</a></li><li><a href="#introduction">INTRODUCTION</a></li><li><a href="#references">References</a></li><li><a href="#notations-and-abbreviations">Notations and Abbreviations</a></li><li><a href="#definitions">Definitions</a></li><li><a href="#cryptographic-systems-and-algorithms">CRYPTOGRAPHIC SYSTEMS AND ALGORITHMS</a></li><li><a href="#cryptographic-systems">Cryptographic Systems</a></li><li><a href="#cryptographic-algorithms">Cryptographic Algorithms</a></li><li><a href="#symmetric-algorithms">Symmetric Algorithms</a></li><li><a href="#asymmetric-algorithms-and-standardized-domain-para">Asymmetric Algorithms and Standardized Domain Parameters</a></li><li><a href="#hashing-algorithms">Hashing algorithms</a></li><li><a href="#cipher-suites">Cipher Suites</a></li><li><a href="#keys-and-certificates">KEYS AND CERTIFICATES</a></li><li><a href="#asymmetric-key-pairs-and-public-key-certificates">Asymmetric Key Pairs and Public Key Certificates</a></li><li><a href="#general">General</a></li><li><a href="#european-level">European Level</a></li><li><a href="#member-state-level">Member State Level</a></li><li><a href="#equipment-level-vehicle-units">Equipment Level: Vehicle Units</a></li><li><a href="#equipment-level-tachograph-cards">Equipment Level: Tachograph Cards</a></li><li><a href="#equipment-level-external-gnss-facilities">Equipment Level: External GNSS Facilities</a></li><li><a href="#overview-certificate-replacement">Overview: Certificate Replacement</a></li><li><a href="#symmetric-keys">Symmetric Keys</a></li><li><a href="#keys-for-securing-vu-motion-sensor-communication">Keys for Securing VU — Motion Sensor Communication</a></li><li><a href="#keys-for-securing-dsrc-communication">Keys for Securing DSRC Communication</a></li><li><a href="#certificates">Certificates</a></li><li><a href="#general">General</a></li><li><a href="#certificate-content">Certificate Content</a></li><li><a href="#requesting-certificates">Requesting Certificates</a></li><li><a href="#vu--card-mutual-authentication-and-secure-messagin">VU- CARD MUTUAL AUTHENTICATION AND SECURE MESSAGING</a></li><li><a href="#general">General</a></li><li><a href="#mutual-certificate-chain-verification">Mutual Certificate Chain Verification</a></li><li><a href="#card-certificate-chain-verification-by-vu">Card Certificate Chain Verification by VU</a></li><li><a href="#vu-certificate-chain-verification-by-card">VU Certificate Chain Verification by Card</a></li><li><a href="#vu-authentication">VU Authentication</a></li><li><a href="#chip-authentication-and-session-key-agreement">Chip Authentication and Session Key Agreement</a></li><li><a href="#secure-messaging">Secure Messaging</a></li><li><a href="#general">General</a></li><li><a href="#secure-message-structure">Secure Message Structure</a></li><li><a href="#secure-messaging-session-abortion">Secure Messaging Session Abortion</a></li><li><a href="#vu-external-gnss-facility-coupling-mutual-authenti">VU — EXTERNAL GNSS FACILITY COUPLING, MUTUAL AUTHENTICATION AND SECURE MESSAGING</a></li><li><a href="#general">General</a></li><li><a href="#vu-and-external-gnss-facility-coupling">VU and External GNSS Facility Coupling</a></li><li><a href="#mutual-certificate-chain-verification">Mutual Certificate Chain Verification</a></li><li><a href="#general">General</a></li><li><a href="#during-vu-egf-coupling">During VU — EGF Coupling</a></li><li><a href="#during-normal-operation">During Normal Operation</a></li><li><a href="#vu-authentication-chip-authentication-and-session">VU Authentication, Chip Authentication and Session Key Agreement</a></li><li><a href="#secure-messaging">Secure Messaging</a></li><li><a href="#vu-motion-sensor-pairing-and-communication">VU — MOTION SENSOR PAIRING AND COMMUNICATION</a></li><li><a href="#general">General</a></li><li><a href="#vu-motion-sensor-pairing-using-different-key-gener">VU — Motion Sensor Pairing Using Different Key Generations</a></li><li><a href="#vu-motion-sensor-pairing-and-communication-using-a">VU — Motion Sensor Pairing and Communication using AES</a></li><li><a href="#vu-motion-sensor-pairing-for-different-equipment-g">VU — Motion Sensor Pairing For Different Equipment Generations</a></li><li><a href="#security-for-remote-communication-over-dsrc">SECURITY FOR REMOTE COMMUNICATION OVER DSRC</a></li><li><a href="#general">General</a></li><li><a href="#tachograph-payload-encryption-and-mac-generation">Tachograph Payload Encryption and MAC Generation</a></li><li><a href="#verification-and-decryption-of-tachograph-payload">Verification and Decryption of Tachograph Payload</a></li><li><a href="#signing-data-downloads-and-verifying-signatures">SIGNING DATA DOWNLOADS AND VERIFYING SIGNATURES</a></li><li><a href="#general">General</a></li><li><a href="#signature-generation">Signature generation</a></li><li><a href="#signature-verification">Signature verification</a></li></ol></nav>
<p>PREAMBLE</p>
<p>This Appendix specifies the security mechanisms ensuring</p>
<dl><dt>—</dt><dd>mutual authentication between different components of the tachograph system.</dd><dt>—</dt><dd>confidentiality, integrity, authenticity and/or non-repudiation of data transferred between different components of the tachograph system or downloaded to external storage media.</dd></dl>

<p>This Appendix consists of two parts. Part A defines the security mechanisms for the first-generation tachograph system (digital tachograph). Part B defines the security mechanisms for the second-generation tachograph system (smart tachograph).</p>
<p>The mechanisms specified in Part A of this Appendix shall apply if at least one of the components of the tachograph system involved in a mutual authentication and/or data transfer process is of the first generation.</p>
<p>The mechanisms specified in Part B of this Appendix shall apply if both components of the tachograph system involved in the mutual authentication and/or data transfer process are of the second generation.</p>
<p>Appendix 15 provides more information regarding the use of first generation components in combination with second-generation components.</p>
<p>PART A</p>
<p>
               <strong>FIRST-GENERATION TACHOGRAPH SYSTEM</strong>
            </p>
<p>1.   <strong>INTRODUCTION</strong>
            </p>
<p>1.1.   <strong>References</strong>
            </p>
<p>The following references are used in this Appendix:</p>
<table>
               <tbody><tr>
                  <td>SHA-1</td>
                  <td>National Institute of Standards and Technology (NIST). FIPS Publication 180-1: Secure Hash Standard. April 1995.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>PKCS1</td>
                  <td>RSA Laboratories. PKCS # 1: RSA Encryption Standard. Version 2.0. October 1998.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TDES</td>
                  <td>National Institute of Standards and Technology (NIST). FIPS Publication 46-3: Data Encryption Standard. Draft 1999.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TDES-OP</td>
                  <td>ANSI X9.52, Triple Data Encryption Algorithm Modes of Operation. 1998.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO/IEC 7816-4</td>
                  <td>Information Technology — Identification cards — Integrated circuit(s) cards with contacts — Part 4: Interindustry commands for interexchange. First edition: 1995 + Amendment 1: 1997.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO/IEC 7816-6</td>
                  <td>Information Technology — Identification cards — Integrated circuit(s) cards with contacts — Part 6: Interindustry data elements. First edition: 1996 + Cor 1: 1998.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO/IEC 7816-8</td>
                  <td>Information Technology — Identification cards — Integrated circuit(s) cards with contacts — Part 8: Security related interindustry commands. First edition 1999.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO/IEC 9796-2</td>
                  <td>Information Technology — Security techniques — Digital signature schemes giving message recovery — Part 2: Mechanisms using a hash function. First edition: 1997.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO/IEC 9798-3</td>
                  <td>Information Technology — Security techniques — Entity authentication mechanisms — Part 3: Entity authentication using a public key algorithm. Second edition 1998.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 16844-3</td>
                  <td>Road vehicles — Tachograph systems — Part 3: Motion sensor interface.</td>
               </tr>
            </tbody></table>
<p>1.2.   <strong>Notations and abbreviated terms</strong>
            </p>
<p>The following notations and abbreviated terms are used in this Appendix:</p>
<table>
               <tbody><tr>
                  <td>(Ka, Kb, Kc)</td>
                  <td>a key bundle for use by the Triple Data Encryption Algorithm,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CA</td>
                  <td>Certification Authority,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CAR</td>
                  <td>Certification Authority Reference,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CC</td>
                  <td>Cryptographic Checksum,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CG</td>
                  <td>Cryptogram,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CH</td>
                  <td>Command Header,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CHA</td>
                  <td>Certificate Holder Authorisation,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CHR</td>
                  <td>Certificate Holder Reference,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>D()</td>
                  <td>Decryption with DES,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DE</td>
                  <td>Data Element,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DO</td>
                  <td>Data Object,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>d</td>
                  <td>RSA private key, private exponent,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>e</td>
                  <td>RSA public key, public exponent,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>E()</td>
                  <td>Encryption with DES,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>EQT</td>
                  <td>Equipment,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Hash()</td>
                  <td>hash value, an output of Hash,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Hash</td>
                  <td>hash function,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KID</td>
                  <td>Key Identifier,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Km</td>
                  <td>TDES key. Master Key defined in ISO 16844-3.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KmVU</td>
                  <td>TDES key inserted in vehicle units.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KmWC</td>
                  <td>TDES key inserted in workshop cards.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>m</td>
                  <td>message representative, an integer between 0 and n-1,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>n</td>
                  <td>RSA keys, modulus,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>PB</td>
                  <td>Padding Bytes,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>PI</td>
                  <td>Padding Indicator byte (for use in Cryptogram for confidentiality DO),</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>PV</td>
                  <td>Plain Value,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>s</td>
                  <td>signature representative, an integer between 0 and n-1,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SSC</td>
                  <td>Send Sequence Counter,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SM</td>
                  <td>Secure Messaging,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TCBC</td>
                  <td>TDEA Cipher Block Chaining Mode of Operation</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TDEA</td>
                  <td>Triple Data Encryption Algorithm,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TLV</td>
                  <td>Tag Length Value,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>VU</td>
                  <td>Vehicle Unit,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.C</td>
                  <td>the certificate of user X issued by a certification authority,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.CA</td>
                  <td>a certification authority of user X,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.CA.PK o X.C</td>
                  <td>the operation of unwrapping a certificate to extract a public key. It is an infix operator, whose left operand is the public key of a certification authority, and whose right operand is the certificate issued by that certification authority. The outcome is the public key of the user X whose certificate is the right operand,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.PK</td>
                  <td>RSA public key of a user X,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.PK[I]</td>
                  <td>RSA encipherment of some information I, using the public key of user X,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.SK</td>
                  <td>RSA private key of a user X,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.SK[I]</td>
                  <td>RSA encipherment of some information I, using the private key of user X,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>‘xx’</td>
                  <td>an Hexadecimal value,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>||</td>
                  <td>concatenation operator.</td>
               </tr>
            </tbody></table>
<p>2.   <strong>CRYPTOGRAPHIC SYSTEMS AND ALGORITHMS</strong>
            </p>
<p>2.1.   <strong>Cryptographic systems</strong>
            </p>
<p>CSM_001 Vehicle units and tachograph cards shall use a classical RSA public-key cryptographic system to provide the following security mechanisms:</p>
<dl><dt>—</dt><dd>authentication between vehicle units and cards,</dd><dt>—</dt><dd>transport of Triple-DES session keys between vehicle units and tachograph cards,</dd><dt>—</dt><dd>digital signature of data downloaded from vehicle units or tachograph cards to external media.</dd></dl>


<p>CSM_002 Vehicle units and tachograph cards shall use a Triple DES symmetric cryptographic system to provide a mechanism for data integrity during user data exchange between vehicle units and tachograph cards, and to provide, where applicable, confidentiality of data exchange between vehicle units and tachograph cards.</p>
<p>2.2.   <strong>Cryptographic algorithms</strong>
            </p>
<p>2.2.1   <strong>RSA algorithm</strong>
            </p>
<p>CSM_003 The RSA algorithm is fully defined by the following relations:</p>
<p>X.SK[<em>m</em>] = <em>s</em> = <em>md</em> mod <em>n</em>
            </p>
<p>X.PK[<em>s</em>] = <em>m</em> = <em>se</em> mod <em>n</em>
            </p>
<p>A more comprehensive description of the RSA function can be found in reference [PKCS1]. Public exponent, e, for RSA calculations is an integer between 3 and n-1 satisfying gcd(e, lcm(p-1, q-1))=1.</p>
<p>2.2.2   <strong>Hash algorithm</strong>
            </p>
<p>CSM_004 The digital signature mechanisms shall use the SHA-1 hash algorithm as defined in reference [SHA-1].</p>
<p>2.2.3   <strong>Data Encryption Algorithm</strong>
            </p>
<p>CSM_005 DES based algorithms shall be used in Cipher Block Chaining mode of operation.</p>
<p>3.   <strong>KEYS AND CERTIFICATES</strong>
            </p>
<p>3.1.   <strong>Keys generation and distribution</strong>
            </p>
<p>3.1.1   <strong>RSA Keys generation and distribution</strong>
            </p>
<p>CSM_006 RSA keys shall be generated through three functional hierarchical levels:</p>
<dl><dt>—</dt><dd>European level,</dd><dt>—</dt><dd>Member State level,</dd><dt>—</dt><dd>Equipment level.</dd></dl>


<p>CSM_007 At European level, a single European key pair (EUR.SK and EUR.PK) shall be generated. The European private key shall be used to certify the Member States public keys. Records of all certified keys shall be kept. These tasks shall be handled by a European Certification Authority, under the authority and responsibility of the European Commission.</p>
<p>CSM_008 At Member State level, a Member State key pair (MS.SK and MS.PK) shall be generated. Member States public keys shall be certified by the European Certification Authority. The Member State private key shall be used to certify public keys to be inserted in equipment (vehicle unit or tachograph card). Records of all certified public keys shall be kept with the identification of the equipment to which it is intended. These tasks shall be handled by a Member State Certification Authority. A Member State may regularly change its key pair.</p>
<p>CSM_009 At equipment level, one single key pair (EQT.SK and EQT.PK) shall be generated and inserted in each equipment. Equipment public keys shall be certified by a Member State Certification Authority. These tasks may be handled by equipment manufacturers, equipment personalisers or Member State authorities. This key pair is used for authentication, digital signature and encipherement services</p>
<p>CSM_010 Private keys confidentiality shall be maintained during generation, transport (if any) and storage.</p>
<p>The following picture summarises the data flow of this process:</p>

<p>3.1.2   <strong>RSA Test keys</strong>
            </p>
<p>CSM_011 For the purpose of equipment testing (including interoperability tests) the European Certification Authority shall generate a different single European test key pair and at least two Member State test key pairs, the public keys of which shall be certified with the European private test key. Manufacturers shall insert, in equipment undergoing type approval tests, test keys certified by one of these Member State test keys.</p>
<p>3.1.3   <strong>Motion sensor keys</strong>
            </p>
<p>The confidentiality of the three Triple DES keys described below shall be appropriately maintained during generation, transport (if any) and storage.</p>
<p>In order to support tachograph components compliant with ISO 16844, the European Certification Authority and the Member State Certification Authorities shall, in addition, ensure the following:</p>
<div>
               <p>CSM_036</p>
                
               <p>The European Certification authority shall generate KmVU and KmWC, two independent and unique Triple DES keys, and generate Km as:</p>
               <div>Km = Km<span>VU</span> XOR Km<span>WC</span>
               </div>
               <p>. The European Certification Authority shall forward these keys, under appropriately secured procedures, to Member States Certification Authorities at their request.</p>
            </div>
<p>CSM_037 Member States Certification Authorities shall:</p>
<dl><dt>—</dt><dd>use Km to encrypt motion sensor data requested by motion sensor manufacturers (data to be encrypted with Km is defined in ISO 16844-3),</dd><dt>—</dt><dd>forward KmVU to vehicle unit manufacturers, under appropriately secured procedures, for insertion in vehicle units,</dd><dt>—</dt><dd>ensure that KmWC will be inserted in all workshop cards ( in elementary file) during card personalisation.</dd></dl>


<p>3.1.4   <strong>T-DES session keys generation and distribution</strong>
            </p>
<p>CSM_012 Vehicle units and tachograph cards shall, as a part of the mutual authentication process, generate and exchange necessary data to elaborate a common Triple DES session key. This exchange of data shall be protected for confidentiality through an RSA crypt-mechanism.</p>
<p>CSM_013 This key shall be used for all subsequent cryptographic operations using secure messaging. Its validity shall expire at the end of the session (withdrawal of the card or reset of the card) and/or after 240 use (one use of the key = one command using secure messaging sent to the card and associated response).</p>
<p>3.2.   <strong>Keys</strong>
            </p>
<p>CSM_014 RSA keys shall have (whatever the level) the following lengths: modulus <em>n</em>1 024  bits, public exponent <em>e</em> 64 bits maximum, private exponent <em>d</em>1 024  bits.</p>
<p>CSM_015 Triple DES keys shall have the form (K<span>a</span>, K<span>b</span>, K<span>a</span>) where K<span>a</span> and K<span>b</span> are independent 64 bits long keys. No parity error detecting bits shall be set.</p>
<p>3.3.   <strong>Certificates</strong>
            </p>
<p>CSM_016 RSA Public key certificates shall be ‘non self-descriptive’‘Card Verifiable’ certificates (Ref.: ISO/IEC 7816-8)</p>
<p>3.3.1   <strong>Certificates content</strong>
            </p>
<p>CSM_017 RSA Public key certificates are built with the following data in the following order:</p>
<p></p>
<p></p><table>
                  <tbody>
                     <tr>
                        <td>Data</td>
                        <td>Format</td>
                        <td>Bytes</td>
                        <td>Obs</td>
                     </tr>
                     <tr>
                        <td>CPI</td>
                        <td>INTEGER</td>
                        <td>1</td>
                        <td>Certificate Profile Identifier (‘01’ for this version)</td>
                     </tr>
                     <tr>
                        <td>CAR</td>
                        <td>OCTET STRING</td>
                        <td>8</td>
                        <td>Certification Authority Reference</td>
                     </tr>
                     <tr>
                        <td>CHA</td>
                        <td>OCTET STRING</td>
                        <td>7</td>
                        <td>Certificate Holder Authorisation</td>
                     </tr>
                     <tr>
                        <td>EOV</td>
                        <td>TimeReal</td>
                        <td>4</td>
                        <td>Certificate end of validity. Optional, ‘FF’ padded if not used.</td>
                     </tr>
                     <tr>
                        <td>CHR</td>
                        <td>OCTET STRING</td>
                        <td>8</td>
                        <td>Certificate Holder Reference</td>
                     </tr>
                     <tr>
                        <td>n</td>
                        <td>OCTET STRING</td>
                        <td>128</td>
                        <td>Public key (modulus)</td>
                     </tr>
                     <tr>
                        <td>e</td>
                        <td>OCTET STRING</td>
                        <td>8</td>
                        <td>Public Key (public exponent)</td>
                     </tr>
                     <tr>
                        <td></td>
                        <td>164</td>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Notes:</em>
            </p>
<p>1. The ‘Certificate Profile Identifier’ (CPI) delineates the exact structure of an authentication certificate. It can be used as an equipment internal identifier of a relevant headerlist which describes the concatenation of Data Elements within the certificate.</p>
<p>The headerlist associated with this certificate content is as follows:</p>
<p></p>
<p></p><table>
                  <tbody>
                     <tr>
                        <td>‘4D’</td>
                        <td>‘16’</td>
                        <td>‘5F 29’</td>
                        <td>‘01’</td>
                        <td>‘42’</td>
                        <td>‘08’</td>
                        <td>‘5F 4B’</td>
                        <td>‘07’</td>
                        <td>‘5F 24’</td>
                        <td>‘04’</td>
                        <td>‘5F 20’</td>
                        <td>‘08’</td>
                        <td>‘7F 49’</td>
                        <td>‘05’</td>
                        <td>‘81’</td>
                        <td>‘81 80’</td>
                        <td>‘82’</td>
                        <td>‘08’</td>
                     </tr>
                     <tr>
                        <td>Extended Headerlist Tag</td>
                        <td>Length of header list</td>
                        <td>CPI Tag</td>
                        <td>CPI Length</td>
                        <td>CAR Tag</td>
                        <td>CAR Length</td>
                        <td>CHA Tag</td>
                        <td>CHA Length</td>
                        <td>EOV Tag</td>
                        <td>EOV Length</td>
                        <td>CHR Tag</td>
                        <td>CHR Length</td>
                        <td>Public Key Tag (Constructed)</td>
                        <td>Length of subsequent DOs</td>
                        <td>modulus Tag</td>
                        <td>modulus length</td>
                        <td>public exponent Tag</td>
                        <td>public exponent length</td>
                     </tr>
                     <tr>
                        <td></td>
                     </tr>
                     <tr>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
<p>2. The ‘Certification Authority Reference’ (CAR) has the purpose of identifying the certificate issuing CA, in such a way that the Data Element can be used at the same time as an Authority Key Identifier to reference the Public Key of the Certification Authority (for coding, see Key Identifier below).</p>
<p>3. The ‘Certificate Holder Authorisation’ (CHA) is used to identify the rights of the certificate holder. It consists of the Tachograph Application ID and of the type of equipment to which the certificate is intended (according to data element, ‘00’ for a Member State).</p>
<p>4. The ‘Certificate Holder Reference’ (CHR) has the purpose of identifying uniquely the certificate holder, in such a way that the Data Element can be used at the same time as a Subject Key Identifier to reference the Public Key of the certificate holder.</p>
<p>5. Key Identifiers uniquely identify certificate holder or certification authorities. They are coded as follows:</p>
<dl><dt>5.1</dt><dd>
                  <p>Equipment (VU or Card):</p>
                  <p></p>
                  <p></p><table>
                        <tbody>
                           <tr>
                              <td>Data</td>
                              <td>Equipment serial number</td>
                              <td>Date</td>
                              <td>Type</td>
                              <td>Manufacturer</td>
                           </tr>
                           <tr>
                              <td>Length</td>
                              <td>4 Bytes</td>
                              <td>2 Bytes</td>
                              <td>1 Byte</td>
                              <td>1 Byte</td>
                           </tr>
                           <tr>
                              <td>Value</td>
                              <td>Integer</td>
                              <td>mm yy BCD coding</td>
                              <td>Manufacturer specific</td>
                              <td>Manufacturer code</td>
                           </tr>
                        </tbody>
                     </table>
                  <p>In the case of a VU, the manufacturer, when requesting certificates, may or may not know the identification of the equipment in which the keys will be inserted.</p>
                  <p>In the first case, the manufacturer will send the equipment identification with the public key to its Member State authority for certification. The certificate will then contain the equipment identification, and the manufacturer must ensure that keys and certificate are inserted in the intended equipment. The Key identifier has the form shown above.</p>
                  <p>In the later case, the manufacturer must uniquely identify each certificate request and send this identification with the public key to its Member State authority for certification. The certificate will contain the request identification. The manufacturer must feed back its Member State authority with the assignment of key to equipment (i.e. certificate request identification, equipment identification) after key installation in the equipment. The key identifier has the following form:</p>
                  <p></p>
                  <p></p><table>
                        <tbody>
                           <tr>
                              <td>Data</td>
                              <td>Certificate request serial number</td>
                              <td>Date</td>
                              <td>Type</td>
                              <td>Manufacturer</td>
                           </tr>
                           <tr>
                              <td>Length</td>
                              <td>4 Bytes</td>
                              <td>2 Bytes</td>
                              <td>1 Byte</td>
                              <td>1 Byte</td>
                           </tr>
                           <tr>
                              <td>Value</td>
                              <td>Integer</td>
                              <td>mm yy BCD coding</td>
                              <td>‘FF’</td>
                              <td>Manufacturer code</td>
                           </tr>
                        </tbody>
                     </table>
               </dd><dt>5.2</dt><dd>
                  <p>Certification Authority:</p>
                  <p></p>
                  <p></p><table>
                        <tbody>
                           <tr>
                              <td>Data</td>
                              <td>Authority Identification</td>
                              <td>Key serial number</td>
                              <td>Additional info</td>
                              <td>Identifier</td>
                           </tr>
                           <tr>
                              <td>Length</td>
                              <td>4 Bytes</td>
                              <td>1 Byte</td>
                              <td>2 Bytes</td>
                              <td>1 Byte</td>
                           </tr>
                           <tr>
                              <td>Value</td>
                              <td>
                                 <p>1 Byte nation numerical code</p>
                                 <p>3 Bytes nation alphanumerical code</p>
                              </td>
                              <td>Integer</td>
                              <td>
                                 <p>additional coding</p>
                                 <p>(CA specific)</p>
                                 <p>‘FF FF’ if not used</p>
                              </td>
                              <td>‘01’</td>
                           </tr>
                        </tbody>
                     </table>
                  <p>The key serial number is used to distinguish the different keys of a Member State, in the case the key is changed.</p>
               </dd></dl>

<p>6. Certificate verifiers shall implicitly know that the public key certified is an RSA key relevant to authentication, digital signature verification and encipherement for confidentiality services (the certificate contains no Object Identifier to specify it).</p>
<p>3.3.2   <strong>Certificates issued</strong>
            </p>
<p>CSM_018 The certificate issued is a digital signature with partial recovery of the certificate content in accordance with ISO/IEC 9796-2 (except for its annex A4), with the ‘Certification Authority Reference’ appended.</p>
<div>X.C = X.CA.SK[&amp;#x2018;6A&amp;#x2019; || C<span>r</span> || <em>Hash</em>(Cc) || &amp;#x2018;BC&amp;#x2019;] || C<span>n</span> || X.CAR</div>
<p></p>
<p></p><table>
                  <tbody>
                     <tr>
                        <td>With certificate content = Cc =</td>
                        <td>Cr</td>
                        <td>||</td>
                        <td>Cn</td>
                     </tr>
                     <tr>
                        <td></td>
                        <td>106 bytes</td>
                        <td></td>
                        <td>58 bytes</td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Notes:</em>
            </p>
<p>1. This certificate is 194 bytes long.</p>
<p>2. CAR, being hidden by the signature, is also appended to the signature, such that the Public Key of the Certification Authority may be selected for the verification of the certificate.</p>
<p>3. The certificate verifier shall implicitly know the algorithm used by the Certification Authority to sign the certificate.</p>
<p>4. The headerlist associated with this issued certificate is as follows:</p>
<p></p>
<p></p><table>
                  <tbody>
                     <tr>
                        <td>‘7F 21’</td>
                        <td>‘09’</td>
                        <td>‘5F 37’</td>
                        <td>‘81 80’</td>
                        <td>‘5F 38’</td>
                        <td>‘3A’</td>
                        <td>‘42’</td>
                        <td>‘08’</td>
                     </tr>
                     <tr>
                        <td>CV Certificate Tag (Constructed)</td>
                        <td>Length of subsequent DOs</td>
                        <td>Signature Tag</td>
                        <td>Signature Length</td>
                        <td>Remainder Tag</td>
                        <td>Remainder Length</td>
                        <td>CAR Tag</td>
                        <td>CAR Length</td>
                     </tr>
                     <tr>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
<p>3.3.3   <strong>Certificate verification and unwrapping</strong>
            </p>
<p>Certificate verification and unwrapping consists in verifying the signature in accordance with ISO/IEC 9796-2, retrieving the certificate content and the public key contained: X.PK = X.CA.PK <span>o</span> X.C, and verifying the validity of the certificate.</p>
<p>CSM_019 It involves the following steps:</p>
<div>Verify signature and retrieve content:</div>
<div>
               <p></p>
               <p></p><table>
                     <tbody>
                        <tr>
                           <td>—  from X.C retrieve Sign, Cn&#39; and CAR&#39;:</td>
                           <td>X.C =</td>
                           <td>Sign</td>
                           <td>||</td>
                           <td>Cn&#39;</td>
                           <td>||</td>
                           <td>CAR&#39;</td>
                        </tr>
                        <tr>
                           <td></td>
                           <td></td>
                           <td>128 Bytes</td>
                           <td></td>
                           <td>58 Bytes</td>
                           <td></td>
                           <td>8 Bytes</td>
                        </tr>
                     </tbody>
                  </table>
            </div>
<div>
               <dl><dt>—</dt><dd>from CAR&#39; select appropriate Certification Authority Public Key (if not done before through other means)</dd><dt>—</dt><dd>open Sign with CA Public Key: Sr&#39;= X.CA.PK [Sign],</dd><dt>—</dt><dd>check Sr&#39; starts with ‘6A’ and ends with ‘BC’</dd></dl>
               
               
            </div>
<div>
               <p></p>
               <p></p><table>
                     <tbody>
                        <tr>
                           <td>—  compute Cr&#39; and H&#39; from: Sr&#39; =</td>
                           <td>‘6A’</td>
                           <td>||</td>
                           <td>Cr&#39;</td>
                           <td>||</td>
                           <td>H&#39;</td>
                           <td>||</td>
                           <td>‘BC’</td>
                        </tr>
                        <tr>
                           <td></td>
                           <td></td>
                           <td></td>
                           <td>106 Bytes</td>
                           <td></td>
                           <td>20 Bytes</td>
                           <td></td>
                           <td></td>
                        </tr>
                     </tbody>
                  </table>
            </div>
<div>
               <dl><dt>—</dt><dd>Recover certificate content C&#39; = Cr&#39; || Cn&#39;,</dd><dt>—</dt><dd>check Hash(C&#39;) = H&#39;</dd></dl>
               
            </div>
<div>If the checks are OK the certificate is a genuine one, its content is C&#39;.</div>
<div>Verify validity. From C&#39;:</div>
<div>
               <dl><dt>—</dt><dd>if applicable, check End of validity date,</dd></dl>
            </div>
<div>Retrieve and store public key, Key Identifier, Certificate Holder Authorisation and Certificate End of Validity from C&#39;:</div>
<div>
               <dl><dt>—</dt><dd>X.PK = n || e</dd><dt>—</dt><dd>X.KID = CHR</dd><dt>—</dt><dd>X.CHA = CHA</dd><dt>—</dt><dd>X.EOV = EOV</dd></dl>
               
               
               
            </div>
<p>4.   <strong>MUTUAL AUTHENTICATION MECHANISM</strong>
            </p>
<p>Mutual authentication between cards and VUs is based on the following principle:</p>
<p>Each party shall demonstrate to the other that it owns a valid key pair, the public key of which has been certified by a Member State certification authority, itself being certified by the European certification authority.</p>
<p>Demonstration is made by signing with the private key a random number sent by the other party, who must recover the random number sent when verifying this signature.</p>
<p>The mechanism is triggered at card insertion by the VU. It starts with the exchange of certificates and unwrapping of public keys, and ends with the setting of a session key.</p>
<p>CSM_020 The following protocol shall be used (arrows indicate commands and data exchanged (see Appendix 2)):</p>


<p>5.   <strong>VU-CARDS DATA TRANSFER CONFIDENTIALITY, INTEGRITY AND AUTHENTICATION MECHANISMS</strong>
            </p>
<p>5.1.   <strong>Secure Messaging</strong>
            </p>
<p>CSM_021 VU-Cards data transfers integrity shall be protected through Secure Messaging in accordance with references [ISO/IEC 7816-4] and [ISO/IEC 7816-8].</p>
<p>CSM_022 When data need to be protected during transfer, a Cryptographic Checksum Data Object shall be appended to the Data Objects sent within the command or the response. The Cryptographic Checksum shall be verified by the receiver.</p>
<p>CSM_023 The cryptographic checksum of data sent within a command shall integrate the command header, and all data objects sent (=&gt;CLA = ‘0C’, and all data objects shall be encapsulated with tags in which b1=1).</p>
<p>CSM_024 The response status-information bytes shall be protected by a cryptographic checksum when the response contains no data field.</p>
<p>CSM_025 Cryptographic checksums shall be 4 Bytes long.</p>
<p>The structure of commands and responses when using secure messaging is therefore the following:</p>
<div>The DOs used are a partial set of the Secure Messaging DOs described in ISO/IEC 7816-4:</div>
<div>
               <p></p>
               <p></p><table>
                     <tbody>
                        <tr>
                           <td>Tag</td>
                           <td>Mnemonic</td>
                           <td>Meaning</td>
                        </tr>
                        <tr>
                           <td>‘81’</td>
                           <td>TPV</td>
                           <td>Plain Value not BER-TLV coded data (to be protected by CC)</td>
                        </tr>
                        <tr>
                           <td>‘97’</td>
                           <td>TLE</td>
                           <td>Value of Le in the unsecured command (to be protected by CC)</td>
                        </tr>
                        <tr>
                           <td>‘99’</td>
                           <td>TSW</td>
                           <td>Status-Info (to be protected by CC)</td>
                        </tr>
                        <tr>
                           <td>‘8E’</td>
                           <td>TCC</td>
                           <td>Cryptographic Checksum</td>
                        </tr>
                        <tr>
                           <td>‘87’</td>
                           <td>TPI CG</td>
                           <td>Padding Indicator Byte || Cryptogram (Plain Value not coded in BER-TLV)</td>
                        </tr>
                     </tbody>
                  </table>
            </div>
<div>Given an unsecured command response pair:</div>
<div>
               <p></p>
               <p></p><table>
                     <tbody>
                        <tr>
                           <td>Command header</td>
                           <td>Command body</td>
                        </tr>
                        <tr>
                           <td>CLA</td>
                           <td>INS</td>
                           <td>P1</td>
                           <td>P2</td>
                           <td>[Lc field]</td>
                           <td>[Data field]</td>
                           <td>[Le field]</td>
                        </tr>
                        <tr>
                           <td>four bytes</td>
                           <td>L bytes, denoted as B1 to BL</td>
                        </tr>
                     </tbody>
                  </table>
            </div>
<div>
               <p></p>
               <p></p><table>
                     <tbody>
                        <tr>
                           <td>Response body</td>
                           <td>Response trailer</td>
                        </tr>
                        <tr>
                           <td>[Data field]</td>
                           <td>SW1</td>
                           <td>SW2</td>
                        </tr>
                        <tr>
                           <td>Lr data bytes</td>
                           <td>two bytes</td>
                        </tr>
                     </tbody>
                  </table>
            </div>
<div>The corresponding secured command response pair is:</div>
<div>
               <div>Secured command:</div>
               <div>
                  <p></p>
                  <p></p><table>
                        <tbody>
                           <tr>
                              <td>Command header (CH)</td>
                              <td>Command body</td>
                           </tr>
                           <tr>
                              <td>CLA</td>
                              <td>INS</td>
                              <td>P1</td>
                              <td>P2</td>
                              <td>[New Lc field]</td>
                              <td>[New Data field]</td>
                              <td>[New Le field]</td>
                           </tr>
                           <tr>
                              <td>‘OC’</td>
                              <td>Length of New Data field</td>
                              <td>TPV</td>
                              <td>LPV</td>
                              <td>PV</td>
                              <td>TLE</td>
                              <td>LLE</td>
                              <td>Le</td>
                              <td>TCC</td>
                              <td>LCC</td>
                              <td>CC</td>
                              <td>‘00’</td>
                           </tr>
                           <tr>
                              <td>‘81’</td>
                              <td>Lc</td>
                              <td>Data field</td>
                              <td>‘97’</td>
                              <td>‘01’</td>
                              <td>Le</td>
                              <td>‘8E’</td>
                              <td>‘04’</td>
                              <td>CC</td>
                           </tr>
                        </tbody>
                     </table>
               </div>
               <div>Data to be integrated in checksum = CH || PB || T<span>PV</span> || L<span>PV</span> || PV || T<span>LE</span> || L<span>LE</span> || L<span>e</span> || PB</div>
               <div>PB = Padding Bytes (80 .. 00) in accordance with ISO-IEC 7816-4 and ISO 9797 method 2.</div>
               <div>DOs PV and LE are present only when there is some corresponding data in the unsecured command.</div>
               <div>Secured response:</div>
               <div>
                  <dl><dt>1.</dt><dd>
                        <p>Case where response data field is not empty and needs not to be protected for confidentiality:</p>
                        <p></p>
                        <p></p><table>
                              <tbody>
                                 <tr>
                                    <td>Response body</td>
                                    <td>Response trailer</td>
                                 </tr>
                                 <tr>
                                    <td>[New Data field]</td>
                                    <td>new SW1 SW2</td>
                                 </tr>
                                 <tr>
                                    <td>TPV</td>
                                    <td>LPV</td>
                                    <td>PV</td>
                                    <td>TCC</td>
                                    <td>LCC</td>
                                    <td>CC</td>
                                    <td></td>
                                 </tr>
                                 <tr>
                                    <td>‘81’</td>
                                    <td>Lr</td>
                                    <td>Data field</td>
                                    <td>‘8E’</td>
                                    <td>‘04’</td>
                                    <td>CC</td>
                                 </tr>
                              </tbody>
                           </table>
                        <p>Data to be integrated in checksum = T<span>PV</span> || L<span>PV</span> || PV || PB</p>
                     </dd><dt>2.</dt><dd>
                        <p>Case where response data field is not empty and needs to be protected for confidentiality:</p>
                        <p></p>
                        <p></p><table>
                              <tbody>
                                 <tr>
                                    <td>Response body</td>
                                    <td>Response trailer</td>
                                 </tr>
                                 <tr>
                                    <td>[New Data field]</td>
                                    <td>new SW1 SW2</td>
                                 </tr>
                                 <tr>
                                    <td>TPI CG</td>
                                    <td>LPI CG</td>
                                    <td>PI CG</td>
                                    <td>TCC</td>
                                    <td>LCC</td>
                                    <td>CC</td>
                                    <td></td>
                                 </tr>
                                 <tr>
                                    <td>‘87’</td>
                                    <td></td>
                                    <td>PI || CG</td>
                                    <td>‘8E’</td>
                                    <td>‘04’</td>
                                    <td>CC</td>
                                 </tr>
                              </tbody>
                           </table>
                        <p>Data to be carried by CG: non BER-TLV coded data and padding bytes.</p>
                        <p>Data to be integrated in checksum = T<span>PI CG</span> || L<span>PI CG</span> || PI CG || PB</p>
                     </dd><dt>3.</dt><dd>
                        <p>Case where response data field is empty:</p>
                        <p></p>
                        <p></p><table>
                              <tbody>
                                 <tr>
                                    <td>Response body</td>
                                    <td>Response trailer</td>
                                 </tr>
                                 <tr>
                                    <td>[New Data field]</td>
                                    <td>new SW1 SW2</td>
                                 </tr>
                                 <tr>
                                    <td>TSW</td>
                                    <td>LSW</td>
                                    <td>SW</td>
                                    <td>TCC</td>
                                    <td>LCC</td>
                                    <td>CC</td>
                                    <td></td>
                                 </tr>
                                 <tr>
                                    <td>‘99’</td>
                                    <td>‘02’</td>
                                    <td>New SW1 SW2</td>
                                    <td>‘8E’</td>
                                    <td>‘04’</td>
                                    <td>CC</td>
                                 </tr>
                              </tbody>
                           </table>
                        <p>Data to be integrated in checksum = T<span>SW</span> || L<span>SW</span> || SW || PB</p>
                     </dd></dl>
                  
                  
               </div>
            </div>
<p>5.2.   <strong>Treatment of Secure Messaging errors</strong>
            </p>
<p>CSM_026 When the tachograph card recognises an SM error while interpreting a command, then the status bytes must be returned without SM. In accordance with ISO/IEC 7816-4, the following status bytes are defined to indicate SM errors:</p>
<table>
               <tbody><tr>
                  <td>‘66 88’</td>
                  <td>:</td>
                  <td>Verification of Cryptographic Checksum failed,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>‘69 87’</td>
                  <td>:</td>
                  <td>Expected SM Data Objects missing,</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>‘69 88’</td>
                  <td>:</td>
                  <td>SM Data Objects incorrect.</td>
               </tr>
            </tbody></table>
<p>CSM_027 When the tachograph card returns status bytes without SM DOs or with an erroneous SM DO, the session must be aborted by the VU.</p>
<p>5.3.   <strong>Algorithm to compute Cryptographic Checksums</strong>
            </p>
<p>CSM_028 Cryptographic checksums are built using a retail MACs in accordance with ANSI X9.19 with DES:</p>
<dl><dt>—</dt><dd>Initial stage: The initial check block y0 is E(Ka, SSC).</dd><dt>—</dt><dd>Sequential stage: The check blocks y1, .., yn are calculated using Ka.</dd><dt>—</dt><dd>Final stage: The cryptographic checksum is calculated from the last check block yn as follows: E(Ka, D(Kb, yn)).</dd></dl>


<p>where E() means encryption with DES, and D() means decryption with DES.</p>
<p>The four most significant bytes of the cryptographic checksum are transferred</p>
<p>CSM_029 The Send Sequence Counter (SSC) shall be initiated during key agreement procedure to:</p>
<p>Initial SSC: Rnd3 (4 least significant bytes) || Rnd1 (4 least significant bytes).</p>
<p>CSM_030 The Send Sequence Counter shall be increased by 1 each time before a MAC is calculated (i.e. the SSC for the first command is Initial SSC + 1, the SSC for the first response is Initial SSC + 2).</p>
<p>The following figure shows the calculation of the retail MAC:</p>

<p>5.4.   <strong>Algorithm to compute cryptograms for confidentiality DOs</strong>
            </p>
<p>CSM_031 Cryptograms are computed using TDEA in TCBC mode of operation in accordance with references [TDES] and [TDES-OP] and with the Null vector as Initial Value block.</p>
<p>The following figure shows the application of keys in TDES:</p>

<p>6.   <strong>DATA DOWNLOAD DIGITAL SIGNATURE MECHANISMS</strong>
            </p>
<p>CSM_032 The Intelligent Dedicated Equipment (IDE) stores data received from an equipment (VU or card) during one download session within one physical data file. This file must contain the certificates MS<span>i</span>.C and EQT.C. The file contains digital signatures of data blocks as specified in Appendix 7 Data Downloading Protocols.</p>
<p>CSM_033 Digital signatures of downloaded data shall use a digital signature scheme with appendix such, that downloaded data may be read without any decipherment if desired.</p>
<p>6.1.   <strong>Signature generation</strong>
            </p>
<p>CSM_034 Data signature generation by the equipment shall follow the signature scheme with appendix defined in reference [PKCS1] with the SHA-1 hash function:</p>
<div>Signature = EQT.SK[‘00’ || ‘01’ || <em>PS</em> || ‘00’ || DER(SHA-1(Data))]</div>
<div>
               <em>PS</em> = Padding string of octets with value ‘FF’ such that length is 128.</div>
<div>DER(SHA-1(<em>M</em>)) is the encoding of the algorithm ID for the hash function and the hash value into an ASN.1 value of type DigestInfo (distinguished encoding rules):</div>
<div>‘30’||‘21’||‘30’||‘09’||‘06’||‘05’||‘2B’||‘0E’||‘03’||‘02’||‘1A’||‘05’||‘00’||‘04’||‘14’||Hash Value.</div>
<p>6.2.   <strong>Signature verification</strong>
            </p>
<p>CSM_035 Data signature verification on downloaded data shall follow the signature scheme with appendix defined in reference [PKCS1] with the SHA-1 hash function.</p>
<p>The European public key EUR.PK needs to be known independently (and trusted) by the verifier.</p>
<p>The following table illustrates the protocol an IDE carrying a Control card can follow to verify the integrity of data downloaded and stored on the ESM (External Storage media). The control card is used to perform the decipherement of digital signatures. This function may in this case not be implemented in the IDE.</p>
<p>The equipment that has downloaded and signed the data to be analysed is denoted EQT.</p>

<p>PART B</p>
<p>
               <strong>SECOND-GENERATION TACHOGRAPH SYSTEM</strong>
            </p>
<p>7.   <strong>INTRODUCTION</strong>
            </p>
<p>7.1.   <strong>References</strong>
            </p>
<p>The following references are used in this part of this Appendix.</p>
<table>
               <tbody><tr>
                  <td>AES</td>
                  <td>National Institute of Standards and Technology (NIST), FIPS PUB 197: Advanced Encryption Standard (AES), November 26, 2001</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DSS</td>
                  <td>National Institute of Standards and Technology (NIST), FIPS PUB 186-4: Digital Signature Standard (DSS), July 2013</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 7816-4</td>
                  <td>ISO/IEC 7816-4, Identification cards — Integrated circuit cards — Part 4: Organization, security and commands for interchange. Third edition 2013-04-15</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 7816-8</td>
                  <td>ISO/IEC 7816-8, Identification cards — Integrated circuit cards — Part 8: Commands for security operations. Second edition 2004-06-01</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 8825-1</td>
                  <td>ISO/IEC 8825-1, Information technology — ASN.1 encoding rules: Specification of Basic Encoding Rules (BER), Canonical Encoding Rules (CER) and Distinguished Encoding Rules (DER). Fourth edition, 2008-12-15</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 9797-1</td>
                  <td>ISO/IEC 9797-1, Information technology — Security techniques — Message Authentication Codes (MACs) — Part 1: Mechanisms using a block cipher. Second edition, 2011-03-01</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 10116</td>
                  <td>ISO/IEC 10116, Information technology — Security techniques — Modes of operation of an n-bit block cipher. Third edition, 2006-02-01</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ISO 16844-3</td>
                  <td>ISO/IEC 16844-3, Road vehicles — Tachograph systems — Part 3: Motion sensor interface. First edition 2004, including Technical Corrigendum 1 2006</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>RFC 5480</td>
                  <td>Elliptic Curve Cryptography Subject Public Key Information, March 2009</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>RFC 5639</td>
                  <td>Elliptic Curve Cryptography (ECC) — Brainpool Standard Curves and Curve Generation, 2010</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>RFC 5869</td>
                  <td>HMAC-based Extract-and-Expand Key Derivation Function (HKDF), May 2010</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SHS</td>
                  <td>National Institute of Standards and Technology (NIST), FIPS PUB 180-4: Secure Hash Standard, March 2012</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SP 800-38B</td>
                  <td>National Institute of Standards and Technology (NIST), Special Publication 800-38B: Recommendation for Block Cipher Modes of Operation: The CMAC Mode for Authentication, 2005</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TR-03111</td>
                  <td>BSI Technical Guideline TR-03111, Elliptic Curve Cryptography, version 2.00, 2012-06-28</td>
               </tr>
            </tbody></table>
<p>7.2.   <strong>Notations and Abbreviations</strong>
            </p>
<p>The following notations and abbreviated terms are used in this Appendix:</p>
<table>
               <tbody><tr>
                  <td>AES</td>
                  <td>Advanced Encryption Standard</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CA</td>
                  <td>Certificate Authority</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CAR</td>
                  <td>Certificate Authority Reference</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CBC</td>
                  <td>Cipher Block Chaining (mode of operation)</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CH</td>
                  <td>Command Header</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CHA</td>
                  <td>Certificate Holder Authorisation</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CHR</td>
                  <td>Certificate Holder Reference</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>CV</td>
                  <td>Constant Vector</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DER</td>
                  <td>Distinguished Encoding Rules</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DO</td>
                  <td>Data Object</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>DSRC</td>
                  <td>Dedicated Short Range Communication</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ECC</td>
                  <td>Elliptic Curve Cryptography</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ECDSA</td>
                  <td>Elliptic Curve Digital Signature Algorithm</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>ECDH</td>
                  <td>Elliptic Curve Diffie-Hellman (key agreement algorithm)</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>EGF</td>
                  <td>External GNSS Facility</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>EQT</td>
                  <td>Equipment</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>IDE</td>
                  <td>Intelligent Dedicated Equipment</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KM</td>
                  <td>Motion Sensor Master Key, allowing the pairing of a Vehicle Unit to a Motion Sensor</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KM-VU</td>
                  <td>Key inserted in vehicle units, allowing a VU to derive the Motion Sensor Master Key if a workshop card is inserted into the VU</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>KM-WC</td>
                  <td>Key inserted in workshop cards, allowing a VU to derive the Motion Sensor Master Key if a workshop card is inserted into the VU</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>MAC</td>
                  <td>Message Authentication Code</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>MoS</td>
                  <td>Motion Sensor</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>MSB</td>
                  <td>Most Significant Bit</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>PKI</td>
                  <td>Public Key Infrastructure</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>RCF</td>
                  <td>Remote Communication Facility</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SSC</td>
                  <td>Send Sequence Counter</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>SM</td>
                  <td>Secure Messaging</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TDES</td>
                  <td>Triple Data Encryption Standard</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>TLV</td>
                  <td>Tag Length Value</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>VU</td>
                  <td>Vehicle Unit</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.C</td>
                  <td>the public key certificate of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.CA</td>
                  <td>the certificate authority that issued the certificate of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.CAR</td>
                  <td>the certificate authority reference mentioned in the certificate of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.CHR</td>
                  <td>the certificate holder reference mentioned in the certificate of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.PK</td>
                  <td>public key of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.SK</td>
                  <td>private key of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.PKeph</td>
                  <td>ephemeral public key of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>X.SKeph</td>
                  <td>ephemeral private key of user X</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>‘xx’</td>
                  <td>a hexadecimal value</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>||</td>
                  <td>concatenation operator</td>
               </tr>
            </tbody></table>
<p>7.3.   <strong>Definitions</strong>
            </p>
<p>The definitions of terms used in this Appendix are included in section I of Annex 1C.</p>
<p>8.   <strong>CRYPTOGRAPHIC SYSTEMS AND ALGORITHMS</strong>
            </p>
<p>8.1.   <strong>Cryptographic Systems</strong>
            </p>
<p>CSM_38 Vehicle units and tachograph cards shall use an elliptic curve-based public-key cryptographic system to provide the following security services:</p>
<dl><dt>—</dt><dd>mutual authentication between a vehicle unit and a card,</dd><dt>—</dt><dd>agreement of AES session keys between a vehicle unit and a card,</dd><dt>—</dt><dd>ensuring the authenticity, integrity and non-repudiation of data downloaded from vehicle units or tachograph cards to external media.</dd></dl>


<p>CSM_39 Vehicle units and external GNSS facilities shall use an elliptic curve-based public-key cryptographic system to provide the following security services:</p>
<dl><dt>—</dt><dd>coupling of a vehicle unit and an external GNSS facility,</dd><dt>—</dt><dd>mutual authentication between a vehicle unit and an external GNSS facility,</dd><dt>—</dt><dd>agreement of an AES session key between a vehicle unit and an external GNSS facility.</dd></dl>


<p>CSM_40 Vehicle units and tachograph cards shall use an AES-based symmetric cryptographic system to provide the following security services:</p>
<dl><dt>—</dt><dd>ensuring authenticity and integrity of data exchanged between a vehicle unit and a tachograph card,</dd><dt>—</dt><dd>where applicable, ensuring confidentiality of data exchanged between a vehicle unit and a tachograph card.</dd></dl>

<p>CSM_41 Vehicle units and external GNSS facilities shall use an AES-based symmetric cryptographic system to provide the following security services:</p>
<dl><dt>—</dt><dd>ensuring authenticity and integrity of data exchanged between a vehicle unit and an external GNSS facility.</dd></dl>
<p>CSM_42 Vehicle units and motion sensors shall use an AES-based symmetric cryptographic system to provide the following security services:</p>
<dl><dt>—</dt><dd>pairing of a vehicle unit and a motion sensor,</dd><dt>—</dt><dd>mutual authentication between a vehicle unit and a motion sensor,</dd><dt>—</dt><dd>ensuring confidentiality of data exchanged between a vehicle unit and a motion sensor.</dd></dl>


<p>CSM_43 Vehicle units and control cards shall use an AES-based symmetric cryptographic system to provide the following security services on the remote communication interface:</p>
<dl><dt>—</dt><dd>ensuring confidentiality, authenticity and integrity of data transmitted from a vehicle unit to a control card.</dd></dl>
<p>
               <em>Notes:</em>
            </p>
<p>— Properly speaking, data is transmitted from a vehicle unit to a remote interrogator under the control of a control officer, using a remote communication facility that may be internal or external to the VU, see Appendix 14. However, the remote interrogator sends the received data to a control card for decryption and validation of authenticity. From a security point of view, the remote communication facility and the remote interrogator are fully transparent.</p>
<p>— A workshop card offers the same security services for the DSRC interface as a control card does. This allows a workshop to validate the proper functioning of the remote communication interface of a VU, including security. Please refer to section 9.2.2 for more information.</p>
<p>8.2.   <strong>Cryptographic Algorithms</strong>
            </p>
<p>8.2.1   <strong>Symmetric Algorithms</strong>
            </p>
<p>CSM_44 Vehicle units, tachograph cards, motion sensors and external GNSS facilities shall support the AES algorithm as defined in [AES], with key lengths of 128, 192 and 256 bits.</p>
<p>8.2.2   <strong>Asymmetric Algorithms and Standardized Domain Parameters</strong>
            </p>
<p>CSM_45 Vehicle units, tachograph cards and external GNSS facilities shall support elliptic curve cryptography with a key size of 256, 384 and 512/521 bits.</p>
<p>CSM_46 Vehicle units, tachograph cards and external GNSS facilities shall support the ECDSA signing algorithm, as specified in [DSS].</p>
<p>CSM_47 Vehicle units, tachograph cards and external GNSS facilities shall support the ECKA-EG key agreement algorithm, as specified in [TR 03111].</p>
<p>CSM_48 Vehicle units, tachograph cards and external GNSS facilities shall support all standardized domain parameters specified in Table 1 below for elliptic curve cryptography.</p>
<p></p>
<p></p><p>
                  <em>Table 1</em>
               </p><p>
                  <strong>Standardized domain parameters</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Name</td>
                        <td>Size (bits)</td>
                        <td>Reference</td>
                        <td>Object identifier</td>
                     </tr>
                     <tr>
                        <td>NIST P-256</td>
                        <td>256</td>
                        <td>[DSS], [RFC 5480]</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>BrainpoolP256r1</td>
                        <td>256</td>
                        <td>[RFC 5639]</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>NIST P-384</td>
                        <td>384</td>
                        <td>[DSS], [RFC 5480]</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>BrainpoolP384r1</td>
                        <td>384</td>
                        <td>[RFC 5639]</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>BrainpoolP512r1</td>
                        <td>512</td>
                        <td>[RFC 5639]</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>NIST P-521</td>
                        <td>521</td>
                        <td>[DSS], [RFC 5480]</td>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Note:</em> the object identifiers mentioned in the last column of Table 1 are specified in [RFC 5639] for the Brainpool curves and in [RFC 5480] for the NIST curves.</p>

<p>8.2.3   <strong>Hashing algorithms</strong>
            </p>
<p>▼M1</p>
<p>CSM_49 Vehicle units, tachograph cards and external GNSS facilities shall support the SHA-256, SHA-384 and SHA-512 algorithms specified in [SHS].</p>
<p>▼B</p>
<p>8.2.4   <strong>Cipher Suites</strong>
            </p>
<p>CSM_50 In case a symmetric algorithm, an asymmetric algorithm and/or a hashing algorithm are used together to form a security protocol, their respective key lengths and hash sizes shall be of (roughly) equal strength. Table 2 shows the allowed cipher suites:</p>
<p></p>
<p></p><p>
                  <em>Table 2</em>
               </p><p>
                  <strong>Allowed cipher suites</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Cipher suite Id</td>
                        <td>ECC key size (bits)</td>
                        <td>AES key length (bits)</td>
                        <td>Hashing algorithm</td>
                        <td>MAC length (bytes)</td>
                     </tr>
                     <tr>
                        <td>CS#1</td>
                        <td>256</td>
                        <td>128</td>
                        <td>SHA-256</td>
                        <td>8</td>
                     </tr>
                     <tr>
                        <td>CS#2</td>
                        <td>384</td>
                        <td>192</td>
                        <td>SHA-384</td>
                        <td>12</td>
                     </tr>
                     <tr>
                        <td>CS#3</td>
                        <td>512/521</td>
                        <td>256</td>
                        <td>SHA-512</td>
                        <td>16</td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Note:</em> ECC keys sizes of 512 bits and 521 bits are considered to be equal in strength for all purposes within this Appendix.</p>
<p>9.   <strong>KEYS AND CERTIFICATES</strong>
            </p>
<p>9.1.   <strong>Asymmetric Key Pairs and Public Key Certificates</strong>
            </p>
<p>9.1.1   <strong>General</strong>
            </p>
<p>
               <em>Note:</em> the keys described in this section are used for mutual authentication and secure messaging between vehicle units and tachograph cards and between vehicle units and external GNSS facilities. These processes are described in detail in chapters 10 and 11 of this Appendix.</p>
<p>CSM_51 Within the European Smart Tachograph system, ECC key pairs and corresponding certificates shall be generated and managed through three functional hierarchical levels:</p>
<dl><dt>—</dt><dd>European level,</dd><dt>—</dt><dd>Member State level,</dd><dt>—</dt><dd>Equipment level.</dd></dl>


<p>CSM_52 Within the entire European Smart Tachograph system, public and private keys and certificates shall be generated, managed and communicated using standardized and secure methods.</p>
<p>9.1.2   <strong>European Level</strong>
            </p>
<p>CSM_53 At European level, a single unique ECC key pair designated as EUR shall be generated. It shall consist of a private key (EUR.SK) and a public key (EUR.PK). This key pair shall form the root key pair of the entire European Smart Tachograph PKI. This task shall be handled by a European Root Certificate Authority (ERCA), under the authority and responsibility of the European Commission.</p>
<p>CSM_54 The ERCA shall use the European private key to sign a (self-signed) root certificate of the European public key, and shall communicate this European root certificate to all Member States.</p>
<p>CSM_55 The ERCA shall use the European private key to sign the certificates of the Member States public keys upon request. The ERCA shall keep records of all signed Member State public key certificates.</p>
<p>CSM_56 As shown in Figure 1 in section 9.1.7, the ERCA shall generate a new European root key pair every 17 years. Whenever the ERCA generates a new European root key pair, it shall create a new self-signed root certificate for the new European public key. The validity period of a European root certificate shall be 34 years plus 3 months.</p>
<p>
               <em>Note:</em> The introduction of a new root key pair also implies that ERCA will generate a new motion sensor master key and a new DSRC master key, see sections 9.2.1.2 and 9.2.2.2.</p>
<p>CSM_57 Before generating a new European root key pair, the ERCA shall conduct an analysis of the cryptographic strength that is needed for the new key pair, given it should stay secure for the next 34 years. If found necessary, the ERCA shall switch to a cipher suite that is stronger than the current one, as specified in CSM_50.</p>
<p>▼M1</p>
<p>CSM_58 Whenever it generates a new European root key pair, the ERCA shall create a link certificate for the new European public key and sign it with the previous European private key. The validity period of the link certificate shall be 17 years plus 3 months. This is shown in Figure 1 in section 9.1.7 as well.</p>
<p>▼B</p>
<p>
               <em>Note:</em> Since a link certificate contains the ERCA generation <em>X</em> public key and is signed with the ERCA generation <em>X-1</em> private key, a link certificate offers equipment issued under generation <em>X-1</em> a method to trust equipment issued under generation <em>X</em>.</p>
<p>CSM_59 The ERCA shall not use the private key of a root key pair for any purpose after the moment a new root key certificate becomes valid.</p>
<p>CSM_60 At any moment in time, the ERCA shall dispose of the following cryptographic keys and certificates:</p>
<dl><dt>—</dt><dd>The current EUR key pair and corresponding certificate</dd><dt>—</dt><dd>All previous EUR certificates to be used for the verification of MSCA certificates that are still valid</dd><dt>—</dt><dd>Link certificates for all generations of EUR certificates except the first one</dd></dl>


<p>9.1.3   <strong>Member State Level</strong>
            </p>
<p>CSM_61 At Member State level, all Member States required to sign tachograph card certificates shall generate one or more unique ECC key pairs designated as MSCA_Card. All Member States required to sign certificates for vehicle units or external GNSS facilities shall additionally generate one or more unique ECC key pairs designated as MSCA_VU-EGF.</p>
<p>CSM_62 The task of generating Member State key pairs shall be handled by a Member State Certificate Authority (MSCA). Whenever a MSCA generates a Member State key pair, it shall send the public key to the ERCA in order to obtain a corresponding Member State certificate signed by the ERCA.</p>
<p>CSM_63 An MSCA shall choose the strength of a Member State key pair equal to the strength of the European root key pair used to sign the corresponding Member State certificate.</p>
<p>CSM_64 An MSCA_VU-EGF key pair, if present, shall consist of private key MSCA_VU-EGF.SK and public key MSCA_VU-EGF.PK. An MSCA shall use the MSCA_VU-EGF.SK private key exclusively to sign the public key certificates of vehicle units and external GNSS facilities.</p>
<p>CSM_65 An MSCA_Card key pair shall consist of private key MSCA_Card.SK and public key MSCA_Card.PK. An MSCA shall use the MSCA_Card.SK private key exclusively to sign the public key certificates of tachograph cards.</p>
<p>CSM_66 An MSCA shall keep records of all signed VU certificates, external GNSS facility certificates and card certificates, together with the identification of the equipment for which each certificate is intended.</p>
<p>CSM_67 The validity period of an MSCA_VU-EGF certificate shall be 17 years plus 3 months. The validity period of an MSCA_Card certificate shall be 7 years plus 1 month.</p>
<p>CSM_68 As shown in Figure 1 in section 9.1.7, the private key of a MSCA_VU-EGF key pair and the private key of a MSCA_Card key pair shall have a key usage period of two years.</p>
<p>CSM_69 An MSCA shall not use the private key of an MSCA_VU-EGF key pair for any purpose after the moment its usage period has ended. Neither shall an MSCA use the private key of an MSCA_Card key pair for any purpose after the moment its usage period has ended.</p>
<p>CSM_70 At any moment in time, an MSCA shall dispose of the following cryptographic keys and certificates:</p>
<dl><dt>—</dt><dd>The current MSCA_Card key pair and corresponding certificate</dd><dt>—</dt><dd>All previous MSCA_Card certificates to be used for the verification of the certificates of tachograph cards that are still valid</dd><dt>—</dt><dd>The current EUR certificate necessary for the verification of the current MSCA certificate</dd><dt>—</dt><dd>All previous EUR certificates necessary for the verification of all MSCA certificates that are still valid</dd></dl>



<p>CSM_71 If an MSCA is required to sign certificates for vehicle units or external GNSS facilities, it shall additionally dispose of the following keys and certificates:</p>
<dl><dt>—</dt><dd>The current MSCA_VU-EGF key pair and corresponding certificate</dd><dt>—</dt><dd>All previous MSCA_VU-EGF public keys to be used for the verification of the certificates of VUs or external GNSS facilities that are still valid</dd></dl>

<p>9.1.4   <strong>Equipment Level: Vehicle Units</strong>
            </p>
<p>▼M1</p>
<p>CSM_72 Two unique ECC key pairs shall be generated for each vehicle unit, designated as VU_MA and VU_Sign. This task is handled by VU manufacturers. Whenever a VU key pair is generated, the party generating the key shall send the public key to its MSCA, in order to obtain a corresponding VU certificate signed by the MSCA. The private key shall be used only by the vehicle unit.</p>
<p>▼B</p>
<p>CSM_73 The VU_MA and VU_Sign certificates of a given vehicle unit shall have the same Certificate Effective Date.</p>
<p>CSM_74 A VU manufacturer shall choose the strength of a VU key pair equal to the strength of the MSCA key pair used to sign the corresponding VU certificate.</p>
<p>CSM_75 A vehicle unit shall use its VU_MA key pair, consisting of private key VU_MA.SK and public key VU_MA.PK, exclusively to perform VU Authentication towards tachograph cards and external GNSS facilities, as specified in sections 10.3 and 11.4 of this Appendix.</p>
<p>CSM_76 A vehicle unit shall be capable of generating ephemeral ECC key pairs and shall use an ephemeral key pair exclusively to perform session key agreement with a tachograph card or external GNSS facility, as specified in sections 10.4 and 11.4 of this Appendix.</p>
<p>CSM_77 A vehicle unit shall use the private key VU_Sign.SK of its VU_Sign key pair exclusively to sign downloaded data files, as specified in chapter 14 of this Appendix. The corresponding public key VU_Sign.PK shall be used exclusively to verify signatures created by the vehicle unit.</p>
<p>CSM_78 As shown in Figure 1 in section 9.1.7, the validity period of a VU_MA certificate shall be 15 years and 3 months. The validity period of a VU_Sign certificate shall also be 15 years and 3 months.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— The extended validity period of a VU_Sign certificate allows a Vehicle Unit to create valid signatures over downloaded data during the first three months after it has expired, as required in Regulation (EU) No 581/2010.</p>
<p>— The extended validity period of a VU_MA certificate is needed to allow the VU to authenticate to a control card or a company card during the first three months after it has expired, such that is it possible to perform a data download.</p>
<p>CSM_79 A vehicle unit shall not use the private key of a VU key pair for any purpose after the corresponding certificate has expired.</p>
<p>CSM_80 The VU key pairs (except ephemeral keys pairs) and corresponding certificates of a given vehicle unit shall not be replaced or renewed in the field once the vehicle unit has been put in operation.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— Ephemeral key pairs are not included in this requirement, as a new ephemeral key pair is generated by a VU each time Chip Authentication and session key agreement is performed, see section 10.4. Note that ephemeral key pairs do not have corresponding certificates.</p>
<p>— This requirement does not forbid the possibility of replacing static VU key pairs during a refurbishment or repair in a secure environment controlled by the VU manufacturer.</p>
<p>CSM_81 When put in operation, vehicle units shall contain the following cryptographic keys and certificates:</p>
<dl><dt>—</dt><dd>The VU_MA private key and corresponding certificate</dd><dt>—</dt><dd>The VU_Sign private key and corresponding certificate</dd><dt>—</dt><dd>The MSCA_VU-EGF certificate containing the MSCA_VU-EGF.PK public key to be used for verification of the VU_MA certificate and VU_Sign certificate</dd><dt>—</dt><dd>The EUR certificate containing the EUR.PK public key to be used for verification of the MSCA_VU-EGF certificate</dd><dt>—</dt><dd>The EUR certificate whose validity period directly precedes the validity period of the EUR certificate to be used to verify the MSCA_VU-EGF certificate, if existing</dd><dt>—</dt><dd>The link certificate linking these two EUR certificates, if existing</dd></dl>





<p>CSM_82 In addition to the cryptographic keys and certificates listed in CSM_81, vehicle units shall also contain the keys and certificates specified in Part A of this Appendix, allowing a vehicle unit to interact with first-generation tachograph cards.</p>
<p>9.1.5   <strong>Equipment Level: Tachograph Cards</strong>
            </p>
<p>▼M1</p>
<p>CSM_83 One unique ECC key pair, designated as Card_MA, shall be generated for each tachograph card. A second unique ECC key pair, designated as Card_Sign, shall additionally be generated for each driver card and each workshop card. This task may be handled by card manufacturers or card personalisers. Whenever a card key pair is generated, the party generating the key shall send the public key to its MSCA, in order to obtain a corresponding card certificate signed by the MSCA. The private key shall be used only by the tachograph card.</p>
<p>▼B</p>
<p>CSM_84 The Card_MA and Card_Sign certificates of a given driver card or workshop card shall have the same Certificate Effective Date.</p>
<p>CSM_85 A card manufacturer or card personaliser shall choose the strength of a card key pair equal to the strength of the MSCA key pair used to sign the corresponding card certificate.</p>
<p>CSM_86 A tachograph card shall use its Card_MA key pair, consisting of private key Card_MA.SK and public key Card_MA.PK, exclusively to perform mutual authentication and session key agreement towards vehicle units, as specified in sections 10.3 and 10.4 of this Appendix.</p>
<p>CSM_87 A driver card or workshop card shall use the private key Card_Sign.SK of its Card_Sign key pair exclusively to sign downloaded data files, as specified in chapter 14 of this Appendix. The corresponding public key Card_Sign.PK shall be used exclusively to verify signatures created by the card.</p>
<p>▼M1</p>
<p>CSM_88 The validity period of a Card_MA certificate shall be as follows:</p>
<dl><dt>—</dt><dd>For driver cards: 5 years</dd><dt>—</dt><dd>For company cards: 5 years</dd><dt>—</dt><dd>For control cards: 2 years</dd><dt>—</dt><dd>For workshop cards: 1 year</dd></dl>



<p>▼B</p>
<p>CSM_89 The validity period of a Card_Sign certificate shall be as follows:</p>
<p></p>
<p></p><table>
                  <tbody>
                     <tr>
                        <td>—  For driver cards:</td>
                        <td>5 years and 1 month</td>
                     </tr>
                     <tr>
                        <td>—  For workshop cards:</td>
                        <td>1 year and 1 month</td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Note:</em> the extended validity period of a Card_Sign certificate allows a driver card to create valid signatures over downloaded data during the first month after it has expired. This is necessary in view of Regulation (EU) No 581/2010, which requires that a data download from a driver card must be possible up to 28 days after the last data has been recorded.</p>
<p>CSM_90 The key pairs and corresponding certificates of a given tachograph card shall not be replaced or renewed once the card has been issued.</p>
<p>CSM_91 When issued, tachograph cards shall contain the following cryptographic keys and certificates:</p>
<dl><dt>—</dt><dd>The Card_MA private key and corresponding certificate</dd><dt>—</dt><dd>For driver cards and workshop cards additionally: the Card_Sign private key and corresponding certificate</dd><dt>—</dt><dd>The MSCA_Card certificate containing the MSCA_Card.PK public key to be used for verification of the Card_MA certificate and Card_Sign certificate</dd><dt>—</dt><dd>The EUR certificate containing the EUR.PK public key to be used for verification of the MSCA_Card certificate.</dd><dt>—</dt><dd>The EUR certificate whose validity period directly precedes the validity period of the EUR certificate to be used to verify the MSCA_Card certificate, if existing.</dd><dt>—</dt><dd>The link certificate linking these two EUR certificates, if existing.</dd></dl>





<p>▼M1</p>
<dl><dt>—</dt><dd>Additionally, for control cards, company cards and workshop cards only, and only if such cards are issued during the first three months of the validity period of a new EUR certificate: the EUR certificate that is two generations older, if existing.</dd></dl>
<p>
               <em>Note to last bullet:</em> For example, in the first three months of the ERCA(3) certificate (see Figure 1), the mentioned cards shall contain the ERCA(1) certificate. This is needed to ensure that these cards can be used to perform data downloads from ERCA(1) VUs whose normal 15-year life period plus the 3-months data downloading period expires during these months; see the last bullet of requirement 13) in Annex IC.</p>
<p>▼B</p>
<p>CSM_92 In addition to the cryptographic keys and certificates listed in CSM_91, tachograph cards shall also contain the keys and certificates specified in Part A of this Appendix, allowing these cards to interact with first-generation VUs.</p>
<p>9.1.6   <strong>Equipment Level: External GNSS Facilities</strong>
            </p>
<p>▼M1</p>
<p>CSM_93 One unique ECC key pair shall be generated for each external GNSS facility, designated as EGF_MA. This task is handled by external GNSS facility manufacturers. Whenever an EGF_MA key pair is generated, the party generating th e key shall send the public key to its MSCA in order to obtain a corresponding EGF_MA certificate signed by the MSCA. The private key shall be used only by the external GNSS facility.</p>
<p>▼B</p>
<p>CSM_94 An EGF manufacturer shall choose the strength of an EGF_MA key pair equal to the strength of the MSCA key pair used to sign the corresponding EGF_MA certificate.</p>
<p>▼M1</p>
<p>CSM_95 An external GNSS facility shall use its EGF_MA key pair, consisting of private key EGF_MA.SK and public key EGF_MA.PK, exclusively to perform mutual authentication and session key agreement towards vehicle units, as specified in section 11.4 of this Appendix.</p>
<p>▼B</p>
<p>CSM_96 The validity period of an EGF_MA certificate shall be 15 years.</p>
<p>CSM_97 An external GNSS facility shall not use the private key of its EGF_MA key pair for coupling to a vehicle unit after the corresponding certificate has expired.</p>
<p>
               <em>Note:</em> as explained in section 11.3.3, an EGF may potentially use its private key for mutual authentication towards the VU it is already coupled to, even after the corresponding certificate has expired.</p>
<p>CSM_98 The EGF_MA key pair and corresponding certificate of a given external GNSS facility shall not be replaced or renewed in the field once the EGF has been put in operation.</p>
<p>
               <em>Note:</em> This requirement does not forbid the possibility of replacing EGF key pairs during a refurbishment or repair in a secure environment controlled by the EGF manufacturer.</p>
<p>CSM_99 When put in operation, an external GNSS facility shall contain the following cryptographic keys and certificates:</p>
<dl><dt>—</dt><dd>The EGF_MA private key and corresponding certificate</dd><dt>—</dt><dd>The MSCA_VU-EGF certificate containing the MSCA_VU-EGF.PK public key to be used for verification of the EGF_MA certificate</dd><dt>—</dt><dd>The EUR certificate containing the EUR.PK public key to be used for verification of the MSCA_VU-EGF certificate</dd><dt>—</dt><dd>The EUR certificate whose validity period directly precedes the validity period of the EUR certificate to be used to verify the MSCA_VU-EGF certificate, if existing</dd><dt>—</dt><dd>The link certificate linking these two EUR certificates, if existing</dd></dl>




<p>9.1.7   <strong>Overview: Certificate Replacement</strong>
            </p>
<p>Figure 1 below shows how different generations of ERCA root certificates, ERCA link certificates, MSCA certificates and equipment (VU and card) certificates are issued and used over time:</p>
<p>▼M1</p>
<p>
               <em>Figure 1</em>
            </p>
<p>
               <strong>Issuance and usage of different generations of ERCA root certificates, ERCA link certificates, MSCA certificates and equipment certificates</strong>
            </p>

<p>▼B</p>
<p>
               <em>Notes to Figure 1:</em>
            </p>
<p>1. Different generations of the root certificate are indicated by a number in brackets. E.g. ERCA (1) is the first generation of ERCA root certificate; ERCA (2) is the second generation, etc.</p>
<p>2. Other certificates are indicated by two numbers in brackets, the first one indicating the root certificate generation under which they are issued, the second one the generation of the certificate itself. E.g. MSCA_Card (1-1) is the first MSCA_Card certificate issued under ERCA (1); MSCA_Card (2-1) is the first MSCA_Card certificate issued under ERCA (2); MSCA_Card (2-last) is the last MSCA_Card certificate issued under ERCA (2); Card_MA(2-1) is the first Card certificate for mutual authentication that is issued under ERCA (2), etc.</p>
<p>3. The MSCA_Card (2-1) and MSCA_Card (1-last) certificates are issued at almost but not exactly the same date. MSCA_Card (2-1) is the first MSCA_Card certificate issued under ERCA (2) and will be issued slightly later than MSCA_Card (1-last), the last MSCA_Card certificate under ERCA (1).</p>
<p>4. As shown in the figure, the first VU and Card certificates issued under ERCA (2) will appear almost two years before the last VU and Card certificates issued under ERCA (1) will appear. This is because of the fact that VU and Card certificates are issued under an MSCA certificate, not directly under the ERCA certificate. The MSCA (2-1) certificate will be issued directly after ERCA (2) becomes valid, but the MSCA (1-last) certificate will be issued only slightly before that time, at the last moment the ERCA (1) certificate is still valid. Therefore, these two MSCA certificates will have almost the same validity period, despite the fact that they are of different generations.</p>
<p>5. The validity period shown for cards is the one for driver cards (5 years).</p>
<p>▼M1</p>
<p>6. To save space, the difference in validity period between the Card_MA and Card_Sign certificates is shown only for the first generation.</p>
<p>▼B</p>
<p>9.2.   <strong>Symmetric Keys</strong>
            </p>
<p>9.2.1   <strong>Keys for Securing VU — Motion Sensor Communication</strong>
            </p>
<p>9.2.1.1   <strong>General</strong>
            </p>
<p>
               <em>Note:</em> readers of this section are supposed to be familiar with the contents of [ISO 16844-3] describing the interface between a vehicle unit and a motion sensor. The pairing process between a VU and a motion sensor is described in detail in chapter 12 of this Appendix.</p>
<p>CSM_100 A number of symmetric keys is needed for pairing vehicle units and motion sensors, for mutual authentication between vehicle units and motion sensors and for encrypting communication between vehicle units and motion sensors, as shown in Table 3. All of these keys shall be AES keys, with a key length equal to the length of the motion sensor master key, which shall be linked to the length of the (foreseen) European root key pair as described in CSM_50.</p>
<p></p>
<p></p><p>
                  <em>Table 3</em>
               </p><p>
                  <strong>Keys for securing vehicle unit — motion sensor communication</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Key</td>
                        <td>Symbol</td>
                        <td>Generated by</td>
                        <td>Generation method</td>
                        <td>Stored by</td>
                     </tr>
                     <tr>
                        <td>Motion Sensor Master Key — VU part</td>
                        <td>KM-VU</td>
                        <td>ERCA</td>
                        <td>Random</td>
                        <td>ERCA, MSCAs involved in issuing VUs certificates, VU manufacturers, vehicle units</td>
                     </tr>
                     <tr>
                        <td>Motion Sensor Master Key — Workshop part</td>
                        <td>KM-WC</td>
                        <td>ERCA</td>
                        <td>Random</td>
                        <td>ERCA, MSCAs, card manufacturers, workshop cards</td>
                     </tr>
                     <tr>
                        <td>Motion Sensor Master Key</td>
                        <td>KM</td>
                        <td>Not independently generated</td>
                        <td>Calculated as KM = KM-VU XOR KM-WC</td>
                        <td>ERCA, MSCAs involved in issuing motion sensors keys (optionally) (*1)</td>
                     </tr>
                     <tr>
                        <td>Identification Key</td>
                        <td>KID</td>
                        <td>Not independently generated</td>
                        <td>Calculated as KID = KM XOR CV, where CV is specified in CSM_106</td>
                        <td>ERCA, MSCAs involved in issuing motion sensors keys (optionally) (*1)</td>
                     </tr>
                     <tr>
                        <td>Pairing Key</td>
                        <td>KP</td>
                        <td>Motion sensor manufacturer</td>
                        <td>Random</td>
                        <td>One motion sensor</td>
                     </tr>
                     <tr>
                        <td>Session Key</td>
                        <td>KS</td>
                        <td>VU (during pairing of VU and motion sensor)</td>
                        <td>Random</td>
                        <td>One VU and one motion sensor</td>
                     </tr>
                     <tr>
                        <td>
                           <div>
                              <a id="E0018">(<sup>*1</sup>)   </a>
                              <p>Storage of K<span>M</span> and K<span>ID</span> is optional, as these keys can be derived from K<span>M-VU</span>, K<span>M-WC</span> and CV.</p>
                           </div>
                        </td>
                     </tr>
                  </tbody>
               </table>
<p>CSM_101 The European Root Certificate Authority shall generate K<span>M-VU</span> and K<span>M-WC</span>, two random and unique AES keys from which the motion sensor master key K<span>M</span> can be calculated as K<span>M-VU</span> XOR K<span>M-WC</span>. The ERCA shall communicate K<span>M,</span> K<span>M-VU</span> and K<span>M-WC</span> to Member State Certificate Authorities upon their request.</p>
<p>CSM_102 The ERCA shall assign to each motion sensor master key K<span>M</span> a unique version number, which shall also be applicable for the constituting keys K<span>M-VU</span> and K<span>M-WC</span> and for the related identification key K<span>ID.</span> The ERCA shall inform the MSCAs about the version number when sending K<span>M-VU</span> and K<span>M-WC</span> to them.</p>
<p>
               <em>Note:</em> The version number is used to distinguish different generations of these keys, as explained in detail in section 9.2.1.2.</p>
<p>CSM_103 A Member State Certificate Authority shall forward K<span>M-VU,</span> together with its version number, to vehicle unit manufacturers upon their request. The VU manufacturers shall insert K<span>M-VU</span> and its version number in all manufactured VUs.</p>
<p>CSM_104 A Member State Certificate Authority shall ensure that K<span>M-WC</span>, together with its version number, is inserted in every workshop card issued under its responsibility.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— See the description of data type in Appendix 2.</p>
<p>— as explained in section 9.2.1.2, in fact multiple generations of K<span>M-WC</span> may have to be inserted in a single workshop card.</p>
<p>CSM_105 In addition to the AES key specified in CSM_104, a MSCA shall ensure that the TDES key Km<span>WC,</span> specified in requirement CSM_037 in Part A of this Appendix, is inserted in every workshop card issued under its responsibility.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— This allows a second-generation workshop card to be used for coupling a first-generation VU.</p>
<p>— A second-generation workshop card will contain two different applications, one complying with Part B of this Appendix and one complying with Part A. The latter will contain the TDES key Km<span>WC</span>.</p>
<p>CSM_106 An MSCA involved in issuing motion sensors shall derive the identification key from the motion sensor master key by XORing it with a constant vector CV. The value of CV shall be as follows:</p>
<p>▼M1</p>
<dl><dt>—</dt><dd>For 128-bit motion sensor master keys: CV = ‘B6 44 2C 45 0E F8 D3 62 0B 7A 8A 97 91 E4 5D 83’</dd></dl>
<p>▼B</p>
<dl><dt>—</dt><dd>For 192-bit motion sensor master keys: CV = ‘72 AD EA FA 00 BB F4 EE F4 99 15 70 5B 7E EE BB 1C 54 ED 46 8B 0E F8 25’</dd><dt>—</dt><dd>For 256-bit motion sensor master keys: CV = ‘1D 74 DB F0 34 C7 37 2F 65 55 DE D5 DC D1 9A C3 23 D6 A6 25 64 CD BE 2D 42 0D 85 D2 32 63 AD 60’</dd></dl>

<p>
               <em>Note:</em> the constant vectors have been generated as follows:</p>
<div>Pi_10 = first 10 bytes of the decimal portion of the mathematical constant π = ‘24 3F 6A 88 85 A3 08 D3 13 19’</div>
<div>CV_128-bits = first 16 bytes of SHA-256(Pi_10)</div>
<div>CV_192-bits = first 24 bytes of SHA-384(Pi_10)</div>
<div>CV_256-bits = first 32 bytes of SHA-512(Pi_10)</div>
<p>CSM_107 
                  
                     
                        ►M1
                     
                   Each Motion sensor manufacturer shall generate a random and unique pairing key K<span>P</span> for every motion sensor, and shall send each pairing key to its Member State Certificate Authority. The MSCA shall encrypt each pairing key separately with the motion sensor master key K<span>M</span> and shall return the encrypted key to the motion sensor manufacturer. For each encrypted key, the MSCA shall notify the motion sensor manufacturer of the version number of the associated K<span>M</span>.<strong>◄</strong>
               </p>
<p>
               <em>Note:</em> as explained in section 9.2.1.2, in fact a motion sensor manufacturer may have to generate multiple unique pairing keys for a single motion sensor.</p>
<p>▼M1</p>
<p>CSM_108 Each motion sensor manufacturer shall generate a unique serial number for every motion sensor, and shall send all serial numbers to its Member State Certificate Authority. The MSCA shall encrypt each serial number separately with the identification key K<span>ID</span> and shall return the encrypted serial number to the motion sensor manufacturer. For each encrypted serial number, the MSCA shall notify the motion sensor manufacturer of the version number of the associated K<span>ID</span>.</p>
<p>▼B</p>
<p>CSM_109 For requirements CSM_107 and CSM_108, the MSCA shall use the AES algorithm in the Cipher Block Chaining mode of operation, as defined in [ISO 10116], with an interleave parameter <em>m</em> = 1 and an initialization vector SV = ‘00’ {16}, i.e. sixteen bytes with binary value 0. When necessary, the MSCA shall use padding method 2 defined in [ISO 9797-1].</p>
<p>CSM_110 The motion sensor manufacturer shall store the encrypted pairing key and the encrypted serial number in the intended motion sensor, together with the corresponding plain text values and the version number of K<span>M</span> and K<span>ID</span> used for encrypting.</p>
<p>
               <em>Note:</em> as explained in section 9.2.1.2, in fact a motion sensor manufacturer may have to insert multiple encrypted pairing keys and multiple encrypted serial numbers in a single motion sensor.</p>
<p>CSM_111 In addition to the AES-based cryptographic material specified in CSM_110, a motion sensor manufacturer may also store in each motion sensor the TDES-based cryptographic material specified in requirement CSM_037 in Part A of this Appendix.</p>
<p>
               <em>Note:</em> doing so will allow a second-generation motion sensor to be coupled to a first-generation VU.</p>
<p>CSM_112 The length of the session key K<span>S</span> generated by a VU during the pairing to a motion sensor shall be linked to the length of its K<span>M-VU,</span> as described in CSM_50.</p>
<p>9.2.1.2   <strong>Motion Sensor Master Key Replacement in Second-Generation Equipment</strong>
            </p>
<p>CSM_113 Each motion sensor master key and all related keys (see Table 3) is associated to a particular generation of the ERCA root key pair. These keys shall therefore be replaced every 17 years. The validity period of each motion sensor master key generation shall begin one year before the associated ERCA root key pair becomes valid and shall end when the associated ERCA root key pair expires. This is depicted in Figure 2.</p>
<p> 
               <em>Figure 2</em> 
                
               <strong>Issuance and usage of different generations of the motion sensor master key in vehicle units, motions sensors and workshop cards</strong> 
               
            </p>
<p>CSM_114 At least one year before generating a new European root key pair, as described in CSM_56, the ERCA shall generate a new motion sensor master key K<span>M</span> by generating a new K<span>M-VU</span> and K<span>M-WC</span>. The length of the motion sensor master key shall be linked to the foreseen strength of the new European root key pair, according to CSM_50. The ERCA shall communicate the new K<span>M</span>, K<span>M-VU</span> and K<span>M-WC</span> to the MSCAs upon their request, together with their version number.</p>
<p>CSM_115 An MSCA shall ensure that all valid generations of K<span>M-WC</span> are stored in every workshop card issued under its authority, together with their version numbers, as shown in Figure 2.</p>
<p>
               <em>Note:</em> this implies that in the last year of the validity period of an ERCA certificate, workshop cards will be issued with three different generations of K<span>M-WC</span>, as shown in Figure 2.</p>
<p>CSM_116 In relation to the process described in CSM_107 and CSM_108 above: An MSCA shall encrypt each pairing key K<span>P</span> it receives from a motion sensor manufacturer separately with each valid generation of the motion sensor master key K<span>M</span>. An MSCA shall also encrypt each serial number it receives from a motion sensor manufacturer separately with each valid generation of the identification key K<span>ID</span>. A motion sensor manufacturer shall store all encryptions of the pairing key and all encryptions of the serial number in the intended motion sensor, together with the corresponding plain text values and the version number(s) of K<span>M</span> and K<span>ID</span> used for encrypting.</p>
<p>
               <em>Note:</em> This implies that in the last year of the validity period of an ERCA certificate, motion sensors will be issued with encrypted data based on three different generations of K<span>M,</span> as shown in Figure 2.</p>
<p>CSM_117 In relation to the process described in CSM_107 above: Since the length of the pairing key K<span>P</span> shall be linked to the length of K<span>M</span> (see CSM_100), a motion sensor manufacturer may have to generate up to three different pairing keys (of different lengths) for one motion sensor, in case subsequent generations of K<span>M</span> have different lengths. In such a case, the manufacturer shall send each pairing key to the MSCA. The MSCA shall ensure that each pairing key is encrypted with the correct generation of the motion sensor master key, i.e. the one having the same length.</p>
<p>
               <em>Note:</em> In case the motion sensor manufacturer chooses to generate a TDES-based pairing key for a second-generation motion sensor (see CSM_111), the manufacturer shall indicate to the MSCA that the TDES-based motion sensor master key must be used for encrypting this pairing key. This is because the length of a TDES key may be equal to that of an AES key, so the MSCA cannot judge from the key length alone.</p>
<p>CSM_118 Vehicle unit manufacturers shall insert only one generation of K<span>M-VU</span> in each vehicle unit, together with its version number. This K<span>M-VU</span> generation shall be linked to the ERCA certificate upon which the VU&#39;s certificates are based.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— A vehicle unit based on the generation <em>X</em> ERCA certificate shall only contain the generation <em>X</em> K<span>M-VU,</span> even if it is issued after the start of the validity period of the generation <em>X+1</em> ERCA certificate. This is shown in Figure 2.</p>
<p>— A VU of generation <em>X</em> cannot be paired to a motion sensor of generation <em>X-1</em>.</p>
<p>— Since workshop cards have a validity period of one year, the result of CSM_113 — CSM_118 is that all workshop cards will contain the new K<span>M-WC</span> at the moment the first VU containing the new K<span>M-VU</span> is issued. Therefore, such a VU will always be able to calculate the new K<span>M.</span> Moreover, by that time most new motion sensors will contain encrypted data based on the new K<span>M</span> as well.</p>
<p>9.2.2   <strong>Keys for Securing DSRC Communication</strong>
            </p>
<p>9.2.2.1   <strong>General</strong>
            </p>
<p>CSM_119 The authenticity and confidentiality of data communicated from a vehicle unit to a control authority over a DSRC remote communication channel shall be ensured by means of a set of VU-specific AES keys derived from a single DSRC master key, KM<span>DSRC</span>.</p>
<p>CSM_120 The DSRC master key KM<span>DSRC</span> shall be an AES key that is securely generated, stored and distributed by the ERCA. The key length may be 128, 192 or 256 bits and shall be linked to the length of the European root key pair, as described in CSM_50.</p>
<p>CSM_121 The ERCA shall communicate the DSRC master key to Member State Certificate Authorities upon their request in a secure manner, to allow them to derive VU-specific DSRC keys and to ensure that the DSRC master key is inserted in all control cards and workshop cards issued under their responsibility.</p>
<p>CSM_122 The ERCA shall assign to each DSRC master key a unique version number. The ERCA shall inform the MSCAs about the version number when sending the DSRC master key to them.</p>
<p>
               <em>Note:</em> The version number is used to distinguish different generations of the DSRC master key, as explained in detail in section 9.2.2.2.</p>
<p>▼M1</p>
<p>CSM_123 For every vehicle unit, the vehicle unit manufacturer shall create a unique VU serial number and shall send this number to its Member State Certificate Authority in a request to obtain a set of two VU-specific DSRC keys. The VU serial number shall have data type .</p>
<p>
               <em>Note:</em>
            </p>
<dl><dt>—</dt><dd>This VU serial number shall be identical to the vuSerialNumber element of VuIdentification, see Appendix 1 and to the Certificate Holder Reference in the VU’s certificates.</dd><dt>—</dt><dd>The VU serial number may not be known at the moment a vehicle unit manufacturer requests the VU-specific DSRC keys. In this case, the VU manufacturer shall send instead the unique certificate request ID it used when requesting the VU’s certificates; see CSM_153. This certificate request ID shall therefore be equal to the Certificate Holder Reference in the VU’s certificates.</dd></dl>

<p>▼B</p>
<p>CSM_124 Upon receiving a request for VU-specific DSRC keys, the MSCA shall derive two AES keys for the vehicle unit, called K_VU<span>DSRC</span>_ENC and K_VU<span>DSRC</span>_MAC. These VU-specific keys shall have the same length as the DSRC master key. The MSCA shall use the key derivation function defined in [RFC 5869]. The hash function that is necessary to instantiate the HMAC-Hash function shall be linked to the length of the DSRC master key, as described in CSM_50. The key derivation function in [RFC 5869] shall be used as follows:</p>
<div>Step 1 (Extract):</div>
<div>
               <dl><dt>—</dt><dd>PRK = HMAC-Hash (salt, IKM) where salt is an empty string ‘ ’ and IKM is KMDSRC.</dd></dl>
            </div>
<div>Step 2 (Expand):</div>
<div>
               <dl><dt>—  —  —</dt><dd>
                     <div>
                        <em>OKM</em> = <em>T(1)</em>, where</div>
                     <div>
                        <em>T(1)</em> = HMAC-Hash (<em>PRK</em>, <em>T(0)</em> || <em>info</em> || ‘01’) with</div>
                     <div>
                        <div>
                           <div>—</div>
                           <div>
                              <div>
                                 <em>T(0)</em> = an empty string (‘
                                                                  ’)</div>
                           </div>
                        </div>
                        <div>
                           <div>—</div>
                           <div>
                              <div>
                                 
                                    
                                       ►M1
                                    
                                  
                                                                  <em>info</em> = VU serial number or certificate request ID, as specified in CSM_123<strong>◄</strong>
                              </div>
                           </div>
                        </div>
                     </div>
                  </dd><dt>—</dt><dd>K_VUDSRC_ENC = first L octets of OKM and K_VUDSRC_MAC = last L octets of OKM where L is the required length of K_VUDSRC_ENC and K_VUDSRC_MAC in octets.</dd></dl>
               
            </div>
<p>CSM_125 The MSCA shall distribute K_VU<span>DSRC</span>_ENC and K_VU<span>DSRC</span>_MAC to the VU manufacturer in a secure manner for insertion in the intended vehicle unit.</p>
<p>CSM_126 When issued, a vehicle unit shall have stored K_VU<span>DSRC</span>_ENC and K_VU<span>DSRC</span>_MAC in its secure memory, in order to be able to ensure the integrity, authenticity and confidentiality of data sent over the remote communication channel. A vehicle unit shall also store the version number of the DSRC master key used to derive these VU-specific keys.</p>
<p>CSM_127 When issued, control cards and workshop cards shall have stored KM<span>DSRC</span> in their secure memory, in order to be able to verify the integrity and authenticity of data sent by a VU over the remote communication channel and to decrypt this data. Control cards and workshop cards shall also store the version number of the DSRC master key.</p>
<p>
               <em>Note:</em> as explained in section 9.2.2.2, in fact multiple generations of KM<span>DSRC</span> may have to be inserted in a single workshop card or control card.</p>
<p>▼M1</p>
<p>CSM_128 The MSCA shall keep records of all VU-specific DSRC keys it generated, their version number and the VU serial number or certificate request ID used in deriving them.</p>
<p>▼B</p>
<p>9.2.2.2   <strong>DSRC Master Key Replacement</strong>
            </p>
<p>CSM_129 Each DSRC master key is associated to a particular generation of the ERCA root key pair. The ERCA shall therefore replace the DSRC master key every 17 years. The validity period of each DSRC master key generation shall begin two years before the associated ERCA root key pair becomes valid and shall end when the associated ERCA root key pair expires. This is depicted in Figure 3.</p>
<p> 
               <em>Figure 3</em> 
                
               <strong>Issuance and usage of different generations of the DSRC master key in vehicle units, workshop cards and control cards</strong> 
               
            </p>
<p>CSM_130 At least two years before generating a new European root key pair, as described in CSM_56, the ERCA shall generate a new DSRC master key. The length of the DSRC key shall be linked to the foreseen strength of the new European root key pair, according to CSM_50. The ERCA shall communicate the new DSRC master key to the MSCAs upon their request, together with its version number.</p>
<p>CSM_131 An MSCA shall ensure that all valid generations of KM<span>DSRC</span> are stored in every control card issued under its authority, together with their version numbers, as shown in Figure 3.</p>
<p>
               <em>Note:</em> this implies that in the last two years of the validity period of an ERCA certificate, control cards will be issued with three different generations of KM<span>DSRC</span>, as shown in Figure 3.</p>
<p>CSM_132 An MSCA shall ensure that all generations of KM<span>DSRC</span> that have been valid for at least a year and are still valid, are stored in every workshop card issued under its authority, together with their version numbers, as shown in Figure 3.</p>
<p>
               <em>Note:</em> this implies that in the last year of the validity period of an ERCA certificate, workshop cards will be issued with three different generations of KM<span>DSRC</span>, as shown in Figure 3.</p>
<p>CSM_133 Vehicle unit manufacturers shall insert only one set of VU-specific DSRC keys into each vehicle unit, together with its version number. This set of keys shall be derived from the KM<span>DSRC</span> generation linked to the ERCA certificate upon which the VU&#39;s certificates are based.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— This implies that a vehicle unit based on the generation <em>X</em> ERCA certificate shall only contain the generation <em>X</em> K_VU<span>DSRC</span>_ENC and K_VU<span>DSRC</span>_MAC<span>,</span> even if the VU is issued after the start of the validity period of the generation <em>X+1</em> ERCA certificate. This is shown in Figure 3.</p>
<p>— Since workshop cards have a validity period of one year and control cards of two years, the result of CSM_131 — CSM_133 is that all workshop cards and control cards will contain the new DSRC master key at the moment the first VU containing VU-specific keys based on that master key will be issued.</p>
<p>9.3.   <strong>Certificates</strong>
            </p>
<p>9.3.1   <strong>General</strong>
            </p>
<p>CSM_134 All certificates in the European Smart Tachograph system shall be self-descriptive, card-verifiable (CV) certificates according to [ISO 7816-4] and [ISO 7816-8].</p>
<p>CSM_135 
                  
                     
                        ►M1
                     
                   The Distinguished Encoding Rules (DER) according to [ISO 8825-1] shall be used to encode the data objects within certificates. Table 4 shows the full certificate encoding, including all tag and length bytes.<strong>◄</strong>
               </p>
<p>
               <em>Note:</em> this encoding results in a Tag-Length-Value (TLV) structure as follows:</p>
<table>
               <tbody><tr>
                  <td>Tag</td>
                  <td>:</td>
                  <td>The tag is encoded in one or two octets and indicates the content.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Length</td>
                  <td>:</td>
                  <td>The length is encoded as an unsigned integer in one, two, or three octets, resulting in a maximum length of 65 535 octets. The minimum number of octets shall be used.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Value</td>
                  <td>:</td>
                  <td>The value is encoded in zero or more octets</td>
               </tr>
            </tbody></table>
<p>9.3.2   <strong>Certificate Content</strong>
            </p>
<p>CSM_136 All certificates shall have the structure shown in the certificate profile in Table 4.</p>
<p></p>
<p></p><p>
                  <em>Table 4</em>
               </p><p>
                  <strong>Certificate Profile version 1</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Field</td>
                        <td>Field ID</td>
                        <td>Tag</td>
                        <td>Length (bytes)</td>
                        <td>
                           <p>ASN.1 data type</p>
                           <p>(see Appendix 1)</p>
                        </td>
                     </tr>
                     <tr>
                        <td>ECC Certificate</td>
                        <td>C</td>
                        <td>‘7F 21’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>ECC Certificate Body</td>
                        <td>B</td>
                        <td>‘7F 4E’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Profile Identifier</td>
                        <td>CPI</td>
                        <td>‘5F 29’</td>
                        <td>‘01’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Authority Reference</td>
                        <td>CAR</td>
                        <td>‘42’</td>
                        <td>‘08’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Holder Authorisation</td>
                        <td>CHA</td>
                        <td>‘5F 4C’</td>
                        <td>‘07’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Public Key</td>
                        <td>PK</td>
                        <td>‘7F 49’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Domain Parameters</td>
                        <td>DP</td>
                        <td>‘06’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Public Point</td>
                        <td>PP</td>
                        <td>‘86’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Holder Reference</td>
                        <td>CHR</td>
                        <td>‘5F 20’</td>
                        <td>‘08’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Effective Date</td>
                        <td>CEfD</td>
                        <td>‘5F 25’</td>
                        <td>‘04’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>Certificate Expiration Date</td>
                        <td>CExD</td>
                        <td>‘5F 24’</td>
                        <td>‘04’</td>
                        <td></td>
                     </tr>
                     <tr>
                        <td>ECC Certificate Signature</td>
                        <td>S</td>
                        <td>‘5F 37’</td>
                        <td>var</td>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Note:</em> the Field ID will be used in later sections of this Appendix to indicate individual fields of a certificate, e.g. X.CAR is the Certificate Authority Reference mentioned in the certificate of user X.</p>
<p>9.3.2.1   <strong>Certificate Profile Identifier</strong>
            </p>
<p>CSM_137 Certificates shall use a Certificate Profile Identifier to indicate the certificate profile used. Version 1, as specified in Table 4, shall be identified by a value of ‘00’.</p>
<p>9.3.2.2   <strong>Certificate Authority Reference</strong>
            </p>
<p>CSM_138 The Certificate Authority Reference shall be used to identify the public key to be used to verify the certificate signature. The Certificate Authority Reference shall therefore be equal to the Certificate Holder Reference in the certificate of the corresponding certificate authority.</p>
<p>CSM_139 An ERCA root certificate shall be self-signed, i.e., the Certificate Authority Reference and the Certificate Holder Reference in the certificate shall be equal.</p>
<p>CSM_140 For an ERCA link certificate, the Certificate Holder Reference shall be equal to the CHR of the new ERCA root certificate. The Certificate Authority Reference for a link certificate shall be equal to the CHR of the previous ERCA root certificate.</p>
<p>9.3.2.3   <strong>Certificate Holder Authorisation</strong>
            </p>
<p>▼M1</p>
<p>CSM_141 The Certificate Holder Authorisation shall be used to identify the type of certificate. It consists of the six most significant bytes of the Tachograph Application ID, concatenated with the equipment type, which indicates the type of equipment for which the certificate is intended. In the case of a VU certificate, a driver card certificate or a workshop card certificate, the equipment type is also used to differentiate between a certificate for Mutual Authentication and a certificate for creating digital signatures (see section 9.1 and Appendix 1, data type EquipmentType).</p>
<p>▼B</p>
<p>9.3.2.4   <strong>Public Key</strong>
            </p>
<p>The Public Key nests two data elements: the standardized domain parameters to be used with the public key in the certificate and the value of the public point.</p>
<p>CSM_142 The data element Domain Parameters shall contain one of the object identifiers specified in Table 1 to reference a set of standardized domain parameters.</p>
<p>CSM_143 The data element Public Point shall contain the public point. Elliptic curve public points shall be converted to octet strings as specified in [TR-03111]. The uncompressed encoding format shall be used. When recovering an elliptic curve point from its encoded format, the validations described in [TR-03111] shall always be carried out.</p>
<p>9.3.2.5   <strong>Certificate Holder Reference</strong>
            </p>
<p>CSM_144 The Certificate Holder Reference is an identifier for the public key provided in the certificate. It shall be used to reference this public key in other certificates.</p>
<p>CSM_145 For card certificates and external GNSS facility certificates, the Certificate Holder Reference shall have the data type specified in Appendix 1.</p>
<p>CSM_146 For vehicle units, the manufacturer, when requesting a certificate, may or may not know the manufacturer-specific serial number of the VU for which that certificate and the associated private key is intended. In the first case, the Certificate Holder Reference shall have the data type specified in Appendix 1. In the latter case, the Certificate Holder Reference shall have the data type specified in Appendix 1.</p>
<p>▼M1</p>
<p>
               <em>Note:</em> For a card certificate, the value of the CHR shall be equal to the value of the cardExtendedSerialNumber in EF_ICC; see Appendix 2. For an EGF certificate, the value of the CHR shall be equal to the value of the sensorGNSSSerialNumber in EF_ICC; see Appendix 14. For a VU certificate, the value of the CHR shall be equal to the vuSerialNumber element of VuIdentification, see Appendix 1, unless the manufacturer does not know the manufacturer-specific serial number at the time the certificate is requested.</p>
<p>▼B</p>
<p>CSM_147 For ERCA and MSCA certificates, the Certificate Holder Reference shall have the data type specified in Appendix 1.</p>
<p>9.3.2.6   <strong>Certificate Effective Date</strong>
            </p>
<p>▼M1</p>
<p>CSM_148 The Certificate Effective Date shall indicate the starting date and time of the validity period of the certificate.</p>
<p>▼B</p>
<p>9.3.2.7   <strong>Certificate Expiration Date</strong>
            </p>
<p>CSM_149 The Certificate Expiration Date shall indicate the end date and time of the validity period of the certificate.</p>
<p>9.3.2.8   <strong>Certificate Signature</strong>
            </p>
<p>CSM_150 The signature on the certificate shall be created over the encoded certificate body, including the certificate body tag and length. The signature algorithm shall be ECDSA, as specified in [DSS], using the hashing algorithm linked to the key size of the signing authority, as specified in CSM_50. The signature format shall be plain, as specified in [TR-03111].</p>
<p>9.3.3   <strong>Requesting Certificates</strong>
            </p>
<p>CSM_151 
                  
                     
                        ►M1
                     
                   When requesting a certificate, an MSCA shall send the following data to the ERCA:<strong>◄</strong>
               </p>
<dl><dt>—</dt><dd>The Certificate Profile Identifier of the requested certificate</dd><dt>—</dt><dd>The Certificate Authority Reference expected to be used for signing the certificate.</dd><dt>—</dt><dd>The Public Key to be signed</dd></dl>


<p>CSM_152 In addition to the data in CSM_151, an MSCA shall send the following data in a certificate request to the ERCA, allowing the ERCA to create the Certificate Holder Reference of the new MSCA certificate:</p>
<dl><dt>—</dt><dd>The numerical nation code of the Certification Authority (data type defined in Appendix 1)</dd><dt>—</dt><dd>The alphanumerical nation code of the Certification Authority (data type defined in Appendix 1)</dd><dt>—</dt><dd>The 1-byte serial number to distinguish the different keys of the Certification Authority in the case keys are changed</dd><dt>—</dt><dd>The two-byte field containing Certification Authority specific additional info</dd></dl>



<p>▼M1</p>
<p>CSM_153 An equipment manufacturer shall send the following data in a certificate request to an MSCA, allowing the MSCA to create the Certificate Holder Reference of the new equipment certificate:</p>
<dl><dt>—</dt><dd>If known (see CSM_154), a serial number for the equipment, unique for the manufacturer, the equipment&#39;s type and the month of manufacturing. Otherwise, a unique certificate request identifier.</dd><dt>—</dt><dd>The month and the year of equipment manufacturing or of the certificate request.</dd></dl>

<p>The manufacturer shall ensure that this data is correct and that the certificate returned by the MSCA is inserted in the intended equipment.</p>
<p>▼B</p>
<p>CSM_154 In the case of a VU, the manufacturer, when requesting a certificate, may or may not know the manufacturer-specific serial number of the VU for which that certificate and the associated private key is intended. If known, the VU manufacturer shall send the serial number to the MSCA. If not known, the manufacturer shall uniquely identify each certificate request and send this certificate request serial number to the MSCA. The resulting certificate will then contain the certificate request serial number. After inserting the certificate in a specific VU, the manufacturer shall communicate the connection between the certificate request serial number and the VU identification to the MSCA.</p>
<p>10.   <strong>VU- CARD MUTUAL AUTHENTICATION AND SECURE MESSAGING</strong>
            </p>
<p>10.1.   <strong>General</strong>
            </p>
<p>CSM_155 On a high level, secure communication between a vehicle unit and a tachograph card shall be based on the following steps:</p>
<dl><dt>—</dt><dd>First, each party shall demonstrate to the other that it owns a valid public key certificate, signed by a Member State Certificate Authority. In turn, the MSCA public key certificate must be signed by the European root certificate authority. This step is called certificate chain verification and is specified in detail in section 10.2</dd><dt>—</dt><dd>Second, the vehicle unit shall demonstrate to the card that it is in possession of the private key corresponding to the public key in the presented certificate. It does so by signing a random number sent by the card. The card verifies the signature over the random number. If this verification is successful, the VU is authenticated. This step is called VU Authentication and is specified in detail in section 10.3.</dd><dt>—</dt><dd>Third, both parties independently calculate two AES session keys using an asymmetric key agreement algorithm. Using one of these session keys, the card creates a message authentication code (MAC) over some data sent by the VU. The VU verifies the MAC. If this verification is successful, the card is authenticated. This step is called Card Authentication and is specified in detail in section 10.4.</dd><dt>—</dt><dd>Fourth, the VU and the card shall use the agreed session keys to ensure the confidentiality, integrity and authenticity of all exchanged messages. This is called Secure Messaging and is specified in detail in section 10.5.</dd></dl>



<p>CSM_156 The mechanism described in CSM_155 shall be triggered by the vehicle unit whenever a card is inserted into one of its card slots.</p>
<p>10.2.   <strong>Mutual Certificate Chain Verification</strong>
            </p>
<p>10.2.1   <strong>Card Certificate Chain Verification by VU</strong>
            </p>
<p>CSM_157  ►M1  Vehicle units shall use the protocol depicted in Figure 4 for verifying a tachograph card’s certificate chain. For every certificate it reads from the card, the VU shall verify that the Certificate Holder Authorisation (CHA) field is correct:</p>
<dl><dt>—</dt><dd>The CHA field of the Card certificate shall indicate a card certificate for mutual authentication (see Appendix 1, data type EquipmentType).</dd><dt>—</dt><dd>The CHA of the Card.CA certificate shall indicate an MSCA.</dd><dt>—</dt><dd>The CHA of the Card.Link certificate shall indicate the ERCA. ◄</dd></dl>


<p>
               <em>Notes to Figure 4:</em>
            </p>
<p>— The Card certificates and public keys mentioned in the figure are those for mutual authentication. Section 9.1.5 denotes these as Card_MA.</p>
<p>— The Card.CA certificates and public keys mentioned in the figure are those for signing card certificates and it is indicated in the CAR of the Card certificate. Section 9.1.3 denotes these as MSCA_Card.</p>
<p>— The Card.CA.EUR certificate mentioned in the figure is the European root certificate that is indicated in the CAR of the Card.CA certificate.</p>
<p>— The Card.Link certificate mentioned in the figure is the card&#39;s link certificate, if present. As specified in section 9.1.2, this is a link certificate for a new European root key pair created by the ERCA and signed by the previous European private key.</p>
<p>— The Card.Link.EUR certificate is the European root certificate that is indicated in the CAR of the Card.Link certificate.</p>
<p>CSM_158 As depicted in Figure 4, verification of the card&#39;s certificate chain shall begin upon card insertion. The vehicle unit shall read the card holder reference () from EF ICC. The VU shall check if it knows the card, i.e., if it has successfully verified the card&#39;s certificate chain in the past and stored it for future reference. If it does, and the card certificate is still valid, the process continues with the verification of the VU certificate chain. Otherwise, the VU shall successively read from the card the MSCA_Card certificate to be used for verifying the card certificate, the Card.CA. EUR certificate to be used for verifying the MSCA_Card certificate, and possibly the link certificate, until it finds a certificate it knows or it can verify. If such a certificate is found, the VU shall use that certificate to verify the underlying card certificates it has read from the card. If successful, the process continues with the verification of the VU certificate chain. If not successful, the VU shall ignore the card.</p>
<p>
               <em>Note:</em> There are three ways in which the VU may know the Card.CA.EUR certificate:</p>
<dl><dt>—</dt><dd>the Card.CA.EUR certificate is the same certificate as the VU&#39;s own EUR certificate;</dd><dt>—</dt><dd>the Card.CA.EUR certificate precedes the VU&#39;s own EUR certificate and the VU contained this certificate already at issuance (see CSM_81);</dd><dt>—</dt><dd>the Card.CA.EUR certificate succeeds the VU&#39;s own EUR certificate and the VU received a link certificate in the past from another tachograph card, verified it and stored it for future reference.</dd></dl>


<p>CSM_159 As indicated in Figure 4, once the VU has verified the authenticity and validity of a previously unknown certificate, it may store this certificate for future reference, such that it does not need to verify that certificate&#39;s authenticity again if it is presented to the VU again. Instead of storing the entire certificate, a VU may choose to store only the contents of the Certificate Body, as specified in section 9.3.2. 
                     
                        ►M1
                     
                   Whereas storing of all other types of certificate is optional, it is mandatory for a VU to store a new link certificate presented by a card.<strong>◄</strong>
               </p>
<p>CSM_160 The VU shall verify the temporal validity of any certificate read from the card or stored in its memory, and shall reject expired certificates. For verifying the temporal validity of a certificate presented by the card a VU shall use its internal clock.</p>
<p>
               <em>Figure 4</em>
            </p>
<p>
               <strong>Protocol for Card Certificate Chain Verification by VU</strong>
            </p>
<p>10.2.2   <strong>VU Certificate Chain Verification by Card</strong>
            </p>
<p>CSM_161  ►M1  Tachograph cards shall use the protocol depicted in Figure 5 for verifying a VU&#39;s certificate chain. For every certificate presented by the VU, the card shall verify that the Certificate Holder Authorisation (CHA) field is correct:</p>
<dl><dt>—</dt><dd>The CHA of the VU.Link certificate shall indicate the ERCA.</dd><dt>—</dt><dd>The CHA of the VU.CA certificate shall indicate an MSCA.</dd><dt>—</dt><dd>The CHA field of the VU certificate shall indicate a VU certificate for mutual authentication (see Appendix 1, data type EquipmentType). ◄</dd></dl>


<p>
               <em>Figure 5</em>
            </p>
<p>
               <strong>Protocol for VU Certificate Chain Verification by Card</strong>
            </p>
<p>
               <em>Notes to Figure 5:</em>
            </p>
<p>— The VU certificates and public keys mentioned in the figure are those for mutual authentication. Section 9.1.4 denotes these as VU_MA.</p>
<p>— The VU.CA certificates and public keys mentioned in the figure are those for signing VU and external GNSS facility certificates. Section 9.1.3 denotes these as MSCA_VU-EGF.</p>
<p>— The VU.CA.EUR certificate mentioned in the figure is the European root certificate that is indicated in the CAR of the VU.CA certificate.</p>
<p>— The VU.Link certificate mentioned in the figure is the VU&#39;s link certificate, if present. As specified in section 9.1.2, this is a link certificate for a new European root key pair created by the ERCA and signed by the previous European private key.</p>
<p>— The VU.Link.EUR certificate is the European root certificate that is indicated in the CAR of the VU.Link certificate.</p>
<p>CSM_162 As depicted in Figure 5, verification of the certificate chain of the vehicle unit shall begin with the vehicle unit attempting to set its own public key for use in the tachograph card. If this succeeds, it means that the card successfully verified the VU&#39;s certificate chain in the past, and has stored the VU certificate for future reference. In this case, the VU certificate is set for use and the process continues with VU Authentication. If the card does not know the VU certificate, the VU shall successively present the VU.CA certificate to be used for verifying its VU certificate, the VU.CA.EUR certificate to be used for verifying the VU.CA certificate, and possibly the link certificate, in order to find a certificate known or verifiable by the card. If such a certificate is found, the card shall use that certificate to verify the underlying VU certificates presented to it. If successful, the VU shall finally set its public key for use in the tachograph card. If not successful, the VU shall ignore the card.</p>
<p>
               <em>Note: There are three ways in which the card may know the VU.CA.EUR certificate:</em>
            </p>
<p>— the VU.CA.EUR certificate is the same certificate as the card&#39;s own EUR certificate;</p>
<p>— the VU.CA.EUR certificate precedes the card&#39;s own EUR certificate and the card contained this certificate already at issuance (see CSM_91);</p>
<p>— the VU.CA.EUR certificate succeeds the card&#39;s own EUR certificate and the card received a link certificate in the past from another vehicle unit, verified it and stored it for future reference.</p>
<p>CSM_163 The VU shall use the MSE: Set AT command to set its public key for use in the tachograph card. As specified in Appendix 2, this command contains an indication of the cryptographic mechanism that will be used with the key that is set. This mechanism shall be ‘VU Authentication using the ECDSA algorithm, in combination with the hashing algorithm linked to the key size of the VU&#39;s VU_MA key pair, as specified in CSM_50’.</p>
<p>CSM_164 The MSE: Set AT command also contains an indication of the ephemeral key pair which the VU will use during session key agreement (see section 10.4). Therefore, before sending the MSE: Set AT command, the VU shall generate an ephemeral ECC key pair. For generating the ephemeral key pair, the VU shall use the standardized domain parameters indicated in the card certificate. The ephemeral key pair is denoted as (VU.SK<span>eph</span>, VU.PK<span>eph</span>, Card.DP). The VU shall take the x-coordinate of the ECDH ephemeral public point as the key identification; this is called the compressed representation of the public key and denoted as Comp(VU.PK<span>eph</span>).</p>
<p>▼M1</p>
<p>CSM_165 If the MSE: Set AT command is successful, the card shall set the indicated VU.PK for subsequent use during Vehicle Authentication, and shall temporarily store Comp(VU.PKeph). In case two or more successful MSE: Set AT commands are sent before session key agreement is performed, the card shall store only the last Comp(VU.PKeph) received. The card shall reset Comp(VU.PKeph) after a successful GENERAL AUTHENTICATE command.</p>
<p>▼B</p>
<p>CSM_166 The card shall verify the temporal validity of any certificate presented by the VU or referenced by the VU while stored in the card&#39;s memory, and shall reject expired certificates.</p>
<p>CSM_167 For verifying the temporal validity of a certificate presented by the VU, each tachograph card shall internally store some data representing the current time. This data shall not be directly updatable by a VU. At issuance, the current time of a card shall be set equal to the Effective Date of the card&#39;s Card_MA certificate. A card shall update its current time if the Effective Date of an authentic ‘valid source of time’ certificate presented by a VU is more recent than the card&#39;s current time. In that case, the card shall set its current time to the Effective Date of that certificate. The card shall accept only the following certificates as a valid source of time:</p>
<dl><dt>—</dt><dd>Second-generation ERCA link certificates</dd><dt>—</dt><dd>Second-generation MSCA certificates</dd><dt>—</dt><dd>Second-generation VU certificates issued by the same country as the card&#39;s own card certificate(s).</dd></dl>


<p>
               <em>Note:</em> the last requirement implies that a card shall be able to recognize the CAR of the VU certificate, i.e. the MSCA_VU-EGF certificate. This will not be the same as the CAR of its own certificate, which is the MSCA_Card certificate.</p>
<p>CSM_168 As indicated in Figure 5, once the card has verified the authenticity and validity of a previously unknown certificate, it may store this certificate for future reference, such that it does not need to verify that certificate&#39;s authenticity again if it is presented to the card again. Instead xof storing the entire certificate, a card may choose to store only the contents of the Certificate Body, as specified in section 9.3.2.</p>
<p>10.3.   <strong>VU Authentication</strong>
            </p>
<p>CSM_169 Vehicle units and cards shall use the VU Authentication protocol depicted in Figure 6 to authenticate the VU towards the card. VU Authentication enables the tachograph card to explicitly verify that the VU is authentic. To do so, the VU shall use its private key to sign a challenge generated by the card.</p>
<p>CSM_170 
                  
                     
                        ►M1
                     
                   Next to the card challenge, the VU shall include in the signature the certificate holder reference taken from the card certificate.<strong>◄</strong>
               </p>
<p>
               <em>Note:</em> This ensures that the card to which the VU authenticates itself is the same card whose certificate chain the VU has verified previously.</p>
<p>CSM_171 The VU shall also include in the signature the identifier of the ephemeral public key Comp(VU.PK<span>eph</span>) which the VU will use to set up Secure Messaging during the Chip Authentication process specified in section 10.4.</p>
<p>
               <em>Note:</em> This ensures that the VU with which a card communicates during a Secure Messaging session is the same VU that was authenticated by the card.</p>
<p>▼M1</p>
<p>
               <em>Figure 6</em>
            </p>
<p>
               <strong>VU Authentication protocol</strong>
            </p>

<p>▼B</p>
<p>CSM_172 If multiple GET CHALLENGE commands are sent by the VU during VU Authentication, the card shall return a new 8-byte random challenge each time, but shall store only the last challenge.</p>
<p>CSM_173 The signing algorithm used by the VU for VU Authentication shall be ECDSA as specified in [DSS], using the hashing algorithm linked to the key size of the VU&#39;s VU_MA key pair, as specified in CSM_50. The signature format shall be plain, as specified in [TR-03111]. The VU shall send the resulting signature to the card.</p>
<p>▼M1</p>
<p>CSM_174 Upon receiving the VU’s signature in an EXTERNAL AUTHENTICATE command, the card shall</p>
<dl><dt>—</dt><dd>Calculate the authentication token by concatenating Card.CHR, the card challenge rcard and the identifier of the VU ephemeral public key Comp(VU.PKeph),</dd><dt>—</dt><dd>Verify the VU’s signature using the ECDSA algorithm, using the hashing algorithm linked to the key size of the VU’s VU_MA key pair as specified in CSM_50, in combination with VU.PK and the calculated authentication token.</dd></dl>

<p>▼B</p>
<p>10.4.   <strong>Chip Authentication and Session Key Agreement</strong>
            </p>
<p>CSM_175 Vehicle units and cards shall use the Chip Authentication protocol depicted in <strong>Figure 7</strong> to authenticate the card towards the VU. Chip Authentication enables the vehicle unit to explicitly verify that the card is authentic.</p>
<p>
               <em>Figure 7</em>
            </p>
<p>
               <strong>Chip Authentication and session key agreement</strong>
            </p>
<p>CSM_176 The VU and the card shall take the following steps:</p>
<dl><dt>1.</dt><dd>The vehicle unit initiates the Chip Authentication process by sending the MSE: Set AT command indicating ‘Chip Authentication using the ECDH algorithm resulting in an AES session key length linked to the key size of the card&#39;s Card_MA key pair, as specified in CSM_50’. The VU shall determine the key size of the card&#39;s key pair from the card certificate.</dd></dl>
<p>▼M1</p>
<dl><dt>2.</dt><dd>The VU sends the public point VU.PKeph of its ephemeral key pair to the card. The public point shall be converted to an octet string as specified in [TR-03111]. The uncompressed encoding format shall be used. As explained in CSM_164, the VU generated this ephemeral key pair prior to the verification of the VU certificate chain. The VU sent the identifier of the ephemeral public key Comp(VU.PKeph) to the card, and the card stored it.</dd></dl>
<p>▼B</p>
<dl><dt>3.</dt><dd>The card computes Comp(VU.PKeph) from VU.PKeph and compares this to the stored value of Comp(VU.PKeph).</dd><dt>4.</dt><dd>Using the ECDH algorithm in combination with the card&#39;s static private key and the VU&#39;s ephemeral public key, the card computes a secret K.</dd><dt>5.</dt><dd>The card chooses a random 8-byte nonce NPICC and uses it to derive two AES session keys KMAC and KENC from K. See CSM_179.</dd></dl>


<p>▼M1</p>
<dl><dt>6.</dt><dd>Using KMAC, the card computes an authentication token over the VU ephemeral public point: TPICC = CMAC(KMAC, VU.PKeph). The public point shall be in the format used by the VU (see bullet 2 above). The card sends NPICC and TPICC to the vehicle unit.</dd></dl>
<p>▼B</p>
<dl><dt>7.</dt><dd>Using the ECDH algorithm in combination with the card&#39;s static public key and the VU&#39;s ephemeral private key, the VU computes the same secret K as the card did in step 4.</dd><dt>8.</dt><dd>The VU derives session keys KMAC and KENC from K and NPICC; see CSM_179.</dd><dt>9.</dt><dd>The VU verifies the authentication token TPICC.</dd></dl>


<p>CSM_177 In step 3 above, the card shall compute Comp(VU.PKeph) as the x-coordinate of the public point in VU.PKeph.</p>
<p>CSM_178 In steps 4 and 7 above, the card and the vehicle unit shall use the ECKA-EG algorithm as defined in [TR-03111].</p>
<p>CSM_179 In steps 5 and 8 above, the card and the vehicle unit shall use the key derivation function for AES session keys defined in [TR-03111], with the following precisions and changes:</p>
<dl><dt>—</dt><dd>The value of the counter shall be ‘00 00 00 01’ for KENC and ‘00 00 00 02’ for KMAC.</dd><dt>—</dt><dd>The optional nonce r shall be used and shall be equal to NPICC.</dd><dt>—</dt><dd>For deriving 128-bits AES keys, the hashing algorithm to be used shall be SHA-256.</dd><dt>—</dt><dd>For deriving 192-bits AES keys, the hashing algorithm to be used shall be SHA-384.</dd><dt>—</dt><dd>For deriving 256-bits AES keys, the hashing algorithm to be used shall be SHA-512.</dd></dl>




<p>The length of the session keys (i.e. the length at which the hash is truncated) shall be linked to the size of the Card_MA key pair, as specified in CSM_50.</p>
<p>CSM_180 In steps 6 and 9 above, the card and the vehicle unit shall use the AES algorithm in CMAC mode, as specified in [SP 800-38B]. The length of T<span>PICC</span> shall be linked to the length of the AES session keys, as specified in CSM_50.</p>
<p>10.5.   <strong>Secure Messaging</strong>
            </p>
<p>10.5.1   <strong>General</strong>
            </p>
<p>CSM_181 All commands and responses exchanged between a vehicle unit and a tachograph card after successful Chip Authentication took place and until the end of the session shall be protected by Secure Messaging.</p>
<p>CSM_182 Except when reading from a file with access condition SM-R-ENC-MAC-G2 (see Appendix 2, section 4), Secure Messaging shall be used in authentication-only mode. In this mode, a cryptographic checksum (a.k.a. MAC) is added to all commands and responses to ensure message authenticity and integrity.</p>
<p>CSM_183 When reading data from a file with access condition SM-R-ENC-MAC-G2, Secure Messaging shall be used in encrypt-then-authenticate mode, i.e. the response data is encrypted first to ensure message confidentiality, and afterwards a MAC over the formatted encrypted data is calculated to ensure authenticity and integrity.</p>
<p>CSM_184 Secure Messaging shall use AES as defined in [AES] with the session keys K<span>MAC</span> and K<span>ENC</span> that were agreed during Chip Authentication.</p>
<p>CSM_185 An unsigned integer shall be used as the Send Sequence Counter (SSC) to prevent replay attacks. The size of the SSC shall be equal to the AES block size, i.e. 128 bits. The SSC shall be in MSB-first format. The Send Sequence Counter shall be initialized to zero (i.e. ‘00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00’) when Secure Messaging is started. The SSC shall be increased every time before a command or response APDU is generated, i.e. since the starting value of the SSC in a SM session is 0, in the first command the value of the SSC will be 1. The value of SSC for the first response will be 2.</p>
<p>CSM_186 For message encryption, K<span>ENC</span> shall be used with AES in the Cipher Block Chaining (CBC) mode of operation, as defined in [ISO 10116], with an interleave parameter <em>m</em> = 1 and an initialization vector SV = E(K<span>ENC</span>, SSC), i.e. the current value of the Send Sequence Counter encrypted with K<span>ENC</span>.</p>
<p>CSM_187 For message authentication, K<span>MAC</span> shall be used with AES in CMAC mode as specified in [SP 800-38B]. The length of the MAC shall be linked to the length of the AES session keys, as specified in CSM_50. The Send Sequence Counter shall be included in the MAC by prepending it before the datagram to be authenticated.</p>
<p>10.5.2   <strong>Secure Message Structure</strong>
            </p>
<p>CSM_188 Secure Messaging shall make use only of the Secure Messaging data objects (see [ISO 7816-4]) listed in Table 5. In any message, these data objects shall be used in the order specified in this table.</p>
<p></p>
<p></p><p>
                  <em>Table 5</em>
               </p><p>
                  <strong>Secure Messaging Data Objects</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Data Object Name</td>
                        <td>Tag</td>
                        <td>Presence (M)andatory, (C)onditional or (F)orbidden in</td>
                     </tr>
                     <tr>
                        <td>Commands</td>
                        <td>Responses</td>
                     </tr>
                     <tr>
                        <td>Plain value not encoded in BER-TLV</td>
                        <td>‘81’</td>
                        <td>C</td>
                        <td>C</td>
                     </tr>
                     <tr>
                        <td>Plain value encoded in BER-TLV, but not including SM DOs</td>
                        <td>‘B3’</td>
                        <td>C</td>
                        <td>C</td>
                     </tr>
                     <tr>
                        <td>Padding-content indicator followed by cryptogram, plain value not encoded in BER-TLV</td>
                        <td>‘87’</td>
                        <td>C</td>
                        <td>C</td>
                     </tr>
                     <tr>
                        <td>Protected Le</td>
                        <td>‘97’</td>
                        <td>C</td>
                        <td>F</td>
                     </tr>
                     <tr>
                        <td>Processing Status</td>
                        <td>‘99’</td>
                        <td>F</td>
                        <td>M</td>
                     </tr>
                     <tr>
                        <td>Cryptographic Checksum</td>
                        <td>‘8E’</td>
                        <td>M</td>
                        <td>M</td>
                     </tr>
                  </tbody>
               </table>
<p>
               <em>Note:</em> As specified in Appendix 2, tachograph cards may support the READ BINARY and UPDATE BINARY command with an odd INS byte (‘B1’ resp. ‘D7’). These command variants are required to read and update files with more than 32 768  bytes or more. In case such a variant is used, a data object with tag ‘B3’ shall be used instead of an object with tag ‘81’. See Appendix 2 for more information.</p>
<p>CSM_189 All SM data objects shall be encoded in DER TLV as specified in [ISO 8825-1]. This encoding results in a Tag-Length-Value (TLV) structure as follows:</p>
<table>
               <tbody><tr>
                  <td>Tag</td>
                  <td>:</td>
                  <td>The tag is encoded in one or two octets and indicates the content.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Length</td>
                  <td>:</td>
                  <td>The length is encoded as an unsigned integer in one, two, or three octets, resulting in a maximum length of 65 535 octets. The minimum number of octets shall be used.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Value</td>
                  <td>:</td>
                  <td>The value is encoded in zero or more octets</td>
               </tr>
            </tbody></table>
<p>CSM_190 APDUs protected by Secure Messaging shall be created as follows:</p>
<dl><dt>—</dt><dd>The command header shall be included in the MAC calculation, therefore value ‘0C’shall be used for the class byte CLA.</dd><dt>—</dt><dd>As specified in Appendix 2, all INS bytes shall be even, with the possible exception of odd INS bytes for the READ BINARY and UPDATE BINARY commands.</dd><dt>—</dt><dd>The actual value of Lc will be modified to Lc&#39; after application of secure messaging.</dd><dt>—</dt><dd>The Data field shall consist of SM data objects.</dd><dt>—</dt><dd>In the protected command APDU the new Le byte shall be set to ‘00’. If required, a data object ‘97’ shall be included in the Data field in order to convey the original value of Le.</dd></dl>




<p>▼M1</p>
<p>CSM_191 Any data object to be encrypted shall be padded according to [ISO 7816-4] using padding-content indicator ‘01’. For the calculation of the MAC, data objects in the APDU shall be padded according to [ISO 7816-4].</p>
<p>
               <em>Note:</em> Padding for Secure Messaging is always performed by the secure messaging layer, not by the CMAC or CBC algorithms.</p>
<p>
               <em>Summary and Examples</em>
            </p>
<p>A command APDU with applied Secure Messaging will have the following structure, depending on the case of the respective unsecured command (DO is data object):</p>
<table>
               <tbody><tr>
                  <td>Case 1</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘8E’ || Le</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 2</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘97’ || DO‘8E’ || Le</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 3 (even INS byte)</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘81’ || DO‘8E’ || Le</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 3 (odd INS byte)</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘B3’ || DO‘8E’ || Le</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 4 (even INS byte)</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘81’ || DO‘97’ || DO‘8E’ || Le</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 4 (odd INS byte)</td>
                  <td>:</td>
                  <td>CLA INS P1 P2 || Lc&#39; || DO ‘B3’ || DO‘97’ || DO‘8E’ || Le</td>
               </tr>
            </tbody></table>
<p>where Le = ‘00’ or ‘00 00’ depending on whether short length fields or extended length fields are used; see [ISO 7816-4].</p>
<p>A response APDU with applied Secure Messaging will have the following structure, depending on the case of the respective unsecured response:</p>
<table>
               <tbody><tr>
                  <td>Case 1 or 3</td>
                  <td>:</td>
                  <td>DO ‘99’ || DO ‘8E’ || SW1SW2</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 2 or 4 (even INS byte) without encryption</td>
                  <td>:</td>
                  <td>DO ‘81’ || DO ‘99’ || DO ‘8E’ || SW1SW2</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 2 or 4 (even INS byte) with encryption</td>
                  <td>:</td>
                  <td>DO ‘87’ || DO ‘99’ || DO ‘8E’ || SW1SW2</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Case 2 or 4 (odd INS byte) without encryption</td>
                  <td>:</td>
                  <td>DO ‘B3’ || DO ‘99’ || DO ‘8E’ || SW1SW2</td>
               </tr>
            </tbody></table>
<p>
               <em>Note:</em> Case 2 or 4 (odd INS byte) with encryption is never used in the communication between a VU and a card.</p>
<p>Below are three example APDU transformations for commands with even INS code. Figure 8 shows an authenticated Case 4 command APDU, Figure 9 shows an authenticated Case 1/Case 3 response APDU, and Figure 10 shows an encrypted and authenticated Case 2/Case 4 response APDU.</p>
<p>
               <em>Figure 8</em>
            </p>
<p>
               <strong>Transformation of an authenticated Case 4 Command APDU</strong>
            </p>
<p>
               <em>Figure 9</em>
            </p>
<p>
               <strong>Transformation of an authenticated Case 1 / Case 3 Response APDU</strong>
            </p>
<p>
               <em>Figure 10</em>
            </p>
<p>
               <strong>Transformation of an encrypted and authenticated Case 2/Case 4 Response APDU</strong>
            </p>

<p>▼B</p>
<p>10.5.3   <strong>Secure Messaging Session Abortion</strong>
            </p>
<p>CSM_192 A vehicle unit shall abort an ongoing Secure Messaging session if and only if one of the following conditions occur:</p>
<dl><dt>—</dt><dd>it receives a plain response APDU,</dd><dt>—  —  —</dt><dd>
                  <div>it detects a Secure Messaging error in a response APDU:</div>
                  <div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>An expected Secure Messaging data object is missing, the order of data objects is incorrect, or an unknown data object is included.</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>A Secure Messaging data object is incorrect, e.g. the MAC value is incorrect, the TLV structure is incorrect or the padding indicator in tag ‘87’ is not equal to ‘01’.</div>
                        </div>
                     </div>
                  </div>
               </dd><dt>—</dt><dd>the card sends a status byte indicating it detected an SM error (see CSM_194),</dd><dt>—</dt><dd>the limit for the number of commands and associated responses within the current session is reached. For a given VU, this limit shall be defined by its manufacturer, taking into account the security requirements of the hardware used, with a maximum value of 240 SM commands and associated responses per session.</dd></dl>



<p>▼M1</p>
<p>CSM_193 A tachograph card shall abort an ongoing Secure Messaging session if and only if one of the following conditions occur:</p>
<dl><dt>—</dt><dd>it receives a plain command APDU,</dd><dt>—  —  —</dt><dd>
                  <div>it detects a Secure Messaging error in a command APDU:</div>
                  <div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>An expected Secure Messaging data object is missing, the order of data objects is incorrect, or an unknown data object is included.</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>A Secure Messaging data object is incorrect, e.g. the MAC value is incorrect or the TLV structure is incorrect.</div>
                        </div>
                     </div>
                  </div>
               </dd><dt>—</dt><dd>it is depowered or reset,</dd><dt>—</dt><dd>the VU starts the VU Authentication process,</dd><dt>—</dt><dd>the limit for the number of commands and associated responses within the current session is reached. For a given card, this limit shall be defined by its manufacturer, taking into account the security requirements of the hardware used, with a maximum value of 240 SM commands and associated responses per session.</dd></dl>




<p>▼B</p>
<p>CSM_194 Regarding SM error handling by a tachograph card:</p>
<dl><dt>—</dt><dd>If in a command APDU some expected Secure Messaging data objects are missing, the order of data objects is incorrect or unknown data objects are included, a tachograph card shall respond with status bytes ‘69 87’.</dd><dt>—</dt><dd>If a Secure Messaging data object in a command APDU is incorrect, a tachograph card shall respond with status bytes ‘69 88’.</dd></dl>

<p>In such a case, the status bytes shall be returned without using SM.</p>
<p>CSM_195 If a Secure Messaging session between a VU and a tachograph card is aborted, the VU and the tachograph card shall</p>
<dl><dt>—</dt><dd>securely destroy the stored session keys</dd><dt>—</dt><dd>immediately establish a new Secure Messaging session, as described in sections 10.2 — 10.5.</dd></dl>

<p>CSM_196 If for any reason the VU decides to restart mutual authentication towards an inserted card, the process shall restart with verification of the card certificate chain, as described in section 10.2, and shall continue as described in sections 10.2 — 10.5.</p>
<p>11.   <strong>VU — EXTERNAL GNSS FACILITY COUPLING, MUTUAL AUTHENTICATION AND SECURE MESSAGING</strong>
            </p>
<p>11.1.   <strong>General</strong>
            </p>
<p>CSM_197 The GNSS facility used by a VU to determine its position may be internal, (i.e. built into the VU casing and not detachable), or it may be an external module. In the first case, there is no need to standardize the internal communication between the GNSS facility and the VU, and the requirements in this chapter do not apply. In the latter case, communication between the VU and the external GNSS facility shall be standardized and protected as described in this chapter.</p>
<p>CSM_198 Secure communication between a vehicle unit and an external GNSS facility shall take place in the same way as secure communication between a vehicle unit and a tachograph card, with the external GNSS facility (EGF) taking the role of the card. All requirements mentioned in chapter 10 for tachograph cards shall be satisfied by an EGF, taking into account the deviations, clarifications and additions mentioned in this chapter. In particular, mutual certificate chain verification, VU Authentication and Chip Authentication shall be performed as described in sections 11.3 and 11.4.</p>
<p>CSM_199 Communication between a vehicle unit and an EGF differs from communication between a vehicle unit and a card in the fact that a vehicle unit and an EGF must be coupled once in a workshop before the VU and the EGF can exchange GNSS-based data during normal operation. The coupling process is described in section 11.2.</p>
<p>CSM_200 For communication between a vehicle unit and an EGF, APDU commands and responses based on [ISO 7816-4] and [ISO 7816-8] shall be used. The exact structure of these APDUs is defined in Appendix 2 of this Annex.</p>
<p>11.2.   <strong>VU and External GNSS Facility Coupling</strong>
            </p>
<p>CSM_201 A vehicle unit and an EGF in a vehicle shall be coupled by a workshop. Only a coupled vehicle unit and EGF shall be able to communicate during normal operation.</p>
<p>CSM_202 Coupling of a vehicle unit and an EGF shall only be possible if the vehicle unit is in calibration mode. The coupling shall be initiated by the vehicle unit.</p>
<p>CSM_203 A workshop may re-couple a vehicle unit to another EGF or to the same EGF at any time. During re-coupling, the VU shall securely destroy the existing EGF_MA certificate in its memory and shall store the EGF_MA certificate of the EGF to which it is being coupled.</p>
<p>CSM_204 A workshop may re-couple an external GNSS facility to another VU or to the same VU at any time. During re-coupling, the EGF shall securely destroy the existing VU_MA certificate in its memory and shall store the VU_MA certificate of the VU to which it is being coupled.</p>
<p>11.3.   <strong>Mutual Certificate Chain Verification</strong>
            </p>
<p>11.3.1   <strong>General</strong>
            </p>
<p>CSM_205 Mutual certificate chain verification between a VU and an EGF shall take place only during the coupling of the VU and the EGF by a workshop. During normal operation of a coupled VU and EGF, no certificates shall be verified. Instead, the VU and EGF shall trust the certificates they stored during the coupling, after checking the temporal validity of these certificates. The VU and the EGF shall not trust any other certificates for protecting the VU — EGF communication during normal operation.</p>
<p>11.3.2   <strong>During VU — EGF Coupling</strong>
            </p>
<p>CSM_206 During the coupling to an EGF, a vehicle unit shall use the protocol depicted in Figure 4 (section 10.2.1) for verifying the external GNSS facility&#39;s certificate chain.</p>
<p>
               <em>Notes to Figure 4 within this context:</em>
            </p>
<p>— Communication control is out of the scope of this Appendix. However, an EGF is not a smart card and hence the VU will probably not send a Reset to initiate the communication and will not receive an ATR.</p>
<p>— The Card certificates and public keys mentioned in the figure shall be interpreted as the EGF&#39;s certificates and public keys for mutual authentication. Section 9.1.6 denotes these as EGF_MA.</p>
<p>— The Card.CA certificates and public keys mentioned in the figure shall be interpreted as the MSCA&#39;s certificates and public keys for signing EGF certificates. Section 9.1.3 denotes these as MSCA_VU-EGF.</p>
<p>— The Card.CA.EUR certificate mentioned in the figure shall be interpreted as the European root certificate that is indicated in the CAR of the MSCA_VU-EGF certificate.</p>
<p>— The Card.Link certificate mentioned in the figure shall be interpreted as the EGF&#39;s link certificate, if present. As specified in section 9.1.2, this is a link certificate for a new European root key pair created by the ERCA and signed by the previous European private key.</p>
<p>— The Card.Link.EUR certificate is the European root certificate that is indicated in the CAR of the Card.Link certificate.</p>
<p>— Instead of the , the VU shall read the from EF ICC.</p>
<p>— Instead of selecting the Tachograph AID, the VU shall select the EGF AID.</p>
<p>— ‘Ignore Card’ shall be interpreted as ‘Ignore EGF’.</p>
<p>CSM_207 Once it has verified the EGF_MA certificate, the vehicle unit shall store this certificate for use during normal operation; see section 11.3.3.</p>
<p>CSM_208 
                  
                     
                        ►M1
                     
                   During the coupling to a VU, an external GNSS facility shall use the protocol depicted in Figure 5 (section 10.2.2) for verifying the VU&#39;s certificate chain.<strong>◄</strong>
               </p>
<p>
               <em>Notes to Figure 5 within this context:</em>
            </p>
<p>— The VU shall generate a fresh ephemeral key pair using the domain parameters in the EGF certificate.</p>
<p>— The VU certificates and public keys mentioned in the figure are those for mutual authentication. Section 9.1.4 denotes these as VU_MA.</p>
<p>— The VU.CA certificates and public keys mentioned in the figure are those for signing VU and external GNSS facility certificates. Section 9.1.3 denotes these as MSCA_VU-EGF.</p>
<p>— The VU.CA.EUR certificate mentioned in the figure is the European root certificate that is indicated in the CAR of the VU.CA certificate.</p>
<p>— The VU.Link certificate mentioned in the figure is the VU&#39;s link certificate, if present. As specified in section 9.1.2, this is a link certificate for a new European root key pair created by the ERCA and signed by the previous European private key.</p>
<p>— The VU.Link.EUR certificate is the European root certificate that is indicated in the CAR of the VU.Link certificate.</p>
<p>CSM_209 In deviation from requirement CSM_167, an EGF shall use the GNSS time to verify the temporal validity of any certificate presented.</p>
<p>▼M1</p>
<p>CSM_210 Once it has verified the VU_MA certificate, the external GNSS facility shall store this certificate for use during normal operation; see section 11.3.3.</p>
<p>▼B</p>
<p>11.3.3   <strong>During Normal Operation</strong>
            </p>
<p>CSM_211 
                  
                     
                        ►M1
                     
                   During normal operation, a vehicle unit and an EGF shall use the protocol depicted in Figure 11 for verifying the temporal validity of the stored EGF_MA certificate and for setting the VU_MA public key for subsequent VU Authentication. No further mutual verification of the certificate chains shall take place during normal operation.<strong>◄</strong>
               </p>
<p>Note that Figure 11 in essence consists of the first steps shown in Figure 4 and Figure 5. Again, note that since an EGF is not a smart card, the VU will probably not send a Reset to initiate the communication and will not receive an ATR. In any case this is out of the scope of this Appendix.</p>
<p>
               <em>Figure 11</em>
            </p>
<p>
               <strong>Mutual verification of certificate temporal validity during normal VU — EGF operation</strong>
            </p>
<p>CSM_212 As shown in Figure 11, the vehicle unit shall log an error if the EGF_MA certificate is no longer valid. However, mutual authentication, key agreement and subsequent communication via secure messaging shall proceed normally.</p>
<p>11.4.   <strong>VU Authentication, Chip Authentication and Session Key Agreement</strong>
            </p>
<p>CSM_213 VU Authentication, Chip Authentication and session key agreement between a VU and an EGF shall take place during coupling and whenever a Secure Messaging session is re-established during normal operation. The VU and the EGF shall carry out the processes described in sections 10.3 and 10.4. All requirements in these sections shall apply.</p>
<p>11.5.   <strong>Secure Messaging</strong>
            </p>
<p>CSM_214 All commands and responses exchanged between a vehicle unit and an external GNSS facility after successful Chip Authentication took place and until the end of the session shall be protected by Secure Messaging.in authentication-only mode. All requirements in section 10.5 shall apply.</p>
<p>CSM_215 If a Secure Messaging session between a VU and an EGF is aborted, the VU shall immediately establish a new Secure Messaging session, as described in section 11.3.3 and 11.4.</p>
<p>12.   <strong>VU — MOTION SENSOR PAIRING AND COMMUNICATION</strong>
            </p>
<p>12.1.   <strong>General</strong>
            </p>
<p>CSM_216 A vehicle unit and a motion sensor shall communicate using the interface protocol specified in [ISO 16844-3] during pairing and in normal operation, with the changes described in this chapter and in section 9.2.1.</p>
<p>
               <em>Note:</em> readers of this chapter are supposed to be familiar with the contents of [ISO 16844-3].</p>
<p>12.2.   <strong>VU — Motion Sensor Pairing Using Different Key Generations</strong>
            </p>
<p>As explained in section 9.2.1, the motion sensor master key and all associated keys are regularly replaced. This leads to the presence of up to three motion sensor-related AES keys K<span>M-WC</span> (of consecutive key generations) in workshop cards. Similarly, in motion sensors up to three different AES-based encryptions of data (based on consecutive generations of the motion sensor master key K<span>M</span>) may be present. A vehicle unit contains only one motion sensor-related key K<span>M-VU.</span>
            </p>
<p>CSM_217 A second-generation VU and a second-generation motion sensor shall be paired as follows (compare Table 6 in [ISO 16844-3]):</p>
<dl><dt>1.</dt><dd>A second-generation workshop card is inserted into the VU and the VU is connected to the motion sensor.</dd><dt>2.</dt><dd>The VU reads all available KM-WC keys from the workshop card, inspects their key version numbers and chooses the one matching the version number of the VU&#39;s KM-VU key. If the matching KM-WC key is not present on the workshop card, the VU aborts the pairing process and shows an appropriate error message to the workshop card holder.</dd><dt>3.</dt><dd>The VU calculates the motion sensor master key KM from KM-VU and KM-WC, and the identification key KID from KM, as specified in section 9.2.1.</dd><dt>4.</dt><dd>The VU sends the instruction to initiate the pairing process towards the motion sensor, as described in [ISO 16844-3], and encrypts the serial number it receives from the motion sensor with the identification key KID. The VU sends the encrypted serial number back to the motion sensor.</dd><dt>5.</dt><dd>The motion sensor matches the encrypted serial number consecutively with each of the encryptions of the serial number it holds internally. If it finds a match, the VU is authenticated. The motion sensor notes the generation of KID used by the VU and returns the matching encrypted version of its pairing key; i.e. the encryption that was created using the same generation of KM.</dd><dt>6.</dt><dd>The VU decrypts the pairing key using KM, generates a session key KS, encrypts it with the pairing key and sends the result to the motion sensor. The motion sensor decrypts KS.</dd><dt>7.</dt><dd>The VU assembles the pairing information as defined in [ISO 16844-3], encrypts the information with the pairing key, and sends the result to the motion sensor. The motion sensor decrypts the pairing information.</dd><dt>8.</dt><dd>The motion sensor encrypts the received pairing information with the received KS and returns this to the VU. The VU verifies that the pairing information is the same information which the VU sent to the motion sensor in the previous step. If it is, this proves that the motion sensor used the same KS as the VU and hence in step 5 sent its pairing key encrypted with the correct generation of KM. Hence, the motion sensor is authenticated.</dd></dl>







<p>Note that steps 2 and 5 are different from the standard process in [ISO 16844-3]; the other steps are standard.</p>
<p>
               <em>Example:</em> Suppose a pairing takes place in the first year of the validity of the ERCA (3) certificate; see Figure 2 in section 9.2.1.2. Moreover</p>
<dl><dt>—  —  —  —  —  —  —</dt><dd>
                  <div>Suppose the motion sensor was issued in the last year of the validity of the ERCA (1) certificate. It will therefore contain the following keys and data:</div>
                  <div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>N<span>s</span>[1]: its serial number encrypted with generation 1 of K<span>ID</span>,</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>N<span>s</span>[2]: its serial number encrypted with generation 2 of K<span>ID</span>,</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>N<span>s</span>[3]: its serial number encrypted with generation 3 of K<span>ID</span>,</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>K<span>P</span>[1]: its generation-1 pairing key (<a href="#E0019" id="src.E0019">
                                 <sup>12</sup>
                              </a>), encrypted with generation 1 of K<span>M</span>,</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>K<span>P</span>[2]: its generation-2 pairing key, encrypted with generation 2 of K<span>M</span>,</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>K<span>P</span>[3]: its generation-3 pairing key, encrypted with generation 3 of K<span>M</span>,</div>
                        </div>
                     </div>
                  </div>
               </dd><dt>—</dt><dd>Suppose that the workshop card was issued in the first year of the validity of the ERCA (3) certificate. It will therefore contain the generation 2 and generation 3 of the KM-WC key.</dd><dt>—</dt><dd>Suppose the VU is a generation-2 VU, containing the generation 2 of KM-VU.</dd></dl>


<p>In this case, the following will happen in steps 2 — 5:</p>
<dl><dt>—</dt><dd>Step 2: The VU reads generation 2 and generation 3 of KM-WC from the workshop card and inspects their version numbers.</dd><dt>—</dt><dd>Step 3: The VU combines the generation-2 KM-WC with its KM-VU to compute KM and KID.</dd><dt>—</dt><dd>Step 4: The VU encrypts the serial number it receives from the motion sensor with KID.</dd><dt>—</dt><dd>Step 5: The motion sensor compares the received data with Ns[1] and doesn&#39;t find a match. Next, it compares the data with Ns[2] and finds a match. It concludes that the VU is a generation-2 VU, and therefore sends back KP[2].</dd></dl>



<p>12.3.   <strong>VU — Motion Sensor Pairing and Communication using AES</strong>
            </p>
<p>CSM_218 As specified in Table 3 in section 9.2.1, all keys involved in the pairing of a (second-generation) vehicle unit and a motion sensor and in subsequent communication shall be AES keys, rather than double-length TDES keys as specified in [ISO 16844-3]. These AES keys may have a length of 128, 192 or 256 bits. Since the AES block size is 16 bytes, the length of an encrypted message must be a multiple of 16 bytes, compared to 8 bytes for TDES. Moreover, some of these messages will be used to transport AES keys, the length of which may be 128, 192 or 256 bits. Therefore, the number of data bytes per instruction in Table 5 of [ISO 16844-3] shall be changed as shown in Table 6:</p>
<p>▼M1</p>
<p></p>
<p></p><p>
                  <em>Table 6</em>
               </p><p>
                  <strong>Number of plaintext and encrypted data bytes per instruction defined in [ISO 16844-3]</strong>
               </p><table>
                  <tbody>
                     <tr>
                        <td>Instruction</td>
                        <td>Request / reply</td>
                        <td>Description of data</td>
                        <td>
                           <p># of plaintext data bytes according to</p>
                           <p>[ISO 16844-3]</p>
                        </td>
                        <td># of plaintext data bytes using AES keys</td>
                        <td># of encrypted data bytes when using AES keys of bitlength</td>
                     </tr>
                     <tr>
                        <td>128</td>
                        <td>192</td>
                        <td>256</td>
                     </tr>
                     <tr>
                        <td>10</td>
                        <td>request</td>
                        <td>Authentication data + file number</td>
                        <td>8</td>
                        <td>8</td>
                        <td>16</td>
                        <td>16</td>
                        <td>16</td>
                     </tr>
                     <tr>
                        <td>11</td>
                        <td>reply</td>
                        <td>Authentication data + file contents</td>
                        <td>16 or 32, depend on file</td>
                        <td>16 or32, depend on file</td>
                        <td>32 / 48</td>
                        <td>32 / 48</td>
                        <td>32 / 48</td>
                     </tr>
                     <tr>
                        <td>41</td>
                        <td>request</td>
                        <td>MoS serial number</td>
                        <td>8</td>
                        <td>8</td>
                        <td>16</td>
                        <td>16</td>
                        <td>16</td>
                     </tr>
                     <tr>
                        <td>41</td>
                        <td>reply</td>
                        <td>Pairing key</td>
                        <td>16</td>
                        <td>16 / 24 / 32</td>
                        <td>16</td>
                        <td>32</td>
                        <td>32</td>
                     </tr>
                     <tr>
                        <td>42</td>
                        <td>request</td>
                        <td>Session key</td>
                        <td>16</td>
                        <td>16 / 24 / 32</td>
                        <td>16</td>
                        <td>32</td>
                        <td>32</td>
                     </tr>
                     <tr>
                        <td>43</td>
                        <td>request</td>
                        <td>Pairing information</td>
                        <td>24</td>
                        <td>24</td>
                        <td>32</td>
                        <td>32</td>
                        <td>32</td>
                     </tr>
                     <tr>
                        <td>50</td>
                        <td>reply</td>
                        <td>Pairing information</td>
                        <td>24</td>
                        <td>24</td>
                        <td>32</td>
                        <td>32</td>
                        <td>32</td>
                     </tr>
                     <tr>
                        <td>70</td>
                        <td>request</td>
                        <td>Authentication data</td>
                        <td>8</td>
                        <td>8</td>
                        <td>16</td>
                        <td>16</td>
                        <td>16</td>
                     </tr>
                     <tr>
                        <td>80</td>
                        <td>reply</td>
                        <td>MoS counter value + auth. data</td>
                        <td>8</td>
                        <td>8</td>
                        <td>16</td>
                        <td>16</td>
                        <td>16</td>
                     </tr>
                  </tbody>
               </table>
<p>▼B</p>
<p>CSM_219 The pairing information that is sent in instructions 43 (VU request) and 50 (MoS reply) shall be assembled as specified in section 7.6.10 of [ISO 16844-3], except that the AES algorithm shall be used instead of the TDES algorithm in the pairing data encryption scheme, thus resulting in two AES encryptions, and adopting the padding specified in CSM_220 to fit with the AES block size. The key K&#39;<span>p</span> used for this encryption shall be generated as follows:</p>
<dl><dt>—</dt><dd>In case the pairing key KP is 16 bytes long: K&#39;p = KP XOR (Ns||Ns)</dd><dt>—</dt><dd>In case the pairing key KP is 24 bytes long: K&#39;p = KP XOR (Ns||Ns||Ns)</dd><dt>—</dt><dd>In case the pairing key KP is 32 bytes long: K&#39;p = KP XOR (Ns||Ns||Ns||Ns)</dd></dl>


<p>where N<span>s</span> is the 8-byte serial number of the motion sensor.</p>
<p>CSM_220 In case the plaintext data length (using AES keys) is not a multiple of 16 bytes, padding method 2 defined in [ISO 9797-1] shall be used.</p>
<p>
               <em>Note:</em> in [ISO 16844-3], the number of plaintext data bytes is always a multiple of 8, such that padding is not necessary when using TDES. The definition of data and messages in [ISO 16844-3] is not changed by this part of this Appendix, thus necessitating the application of padding.</p>
<p>CSM_221 For instruction 11 and in case more than one block of data must be encrypted, the Cipher Block Chaining mode of operation shall be used as defined in [ISO 10116], with an interleave parameter <em>m</em> = 1. The IV to be used shall be</p>
<dl><dt>—</dt><dd>For instruction 11: the 8-byte authentication block specified in section 7.6.3.3 of [ISO 16844-3], padded using padding method 2 defined in [ISO 9797-1]; see also section 7.6.5 and 7.6.6 of [ISO 16844-3].</dd><dt>—</dt><dd>For all other instructions in which more than 16 bytes are transferred, as specified in Table 6: ‘00’ {16}, i.e. sixteen bytes with binary value 0.</dd></dl>

<p>
               <em>Note:</em> As shown in section 7.6.5 and 7.6.6 of [ISO 16844-3], when the MoS encrypts data files for inclusion in instruction 11, the authentication block is both</p>
<dl><dt>—</dt><dd>Used as the initialization vector for the CBC-mode encryption of the data files</dd><dt>—</dt><dd>Encrypted and included as the first block in the data that is sent to the VU.</dd></dl>

<p>12.4.   <strong>VU — Motion Sensor Pairing For Different Equipment Generations</strong>
            </p>
<p>CSM_222 As explained in section 9.2.1, a second-generation motion sensor may contain the TDES-based encryption of the pairing data (as defined in Part A of this Appendix), which allows the motion sensor to be paired to a first-generation VU. If this is the case, a first-generation VU and a second-generation motion sensor shall be paired as described in Part A of this Appendix and in [ISO 16844-3]. For the pairing process either a first-generation or a second-generation workshop card may be used.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— It is not possible to pair a second-generation VU to a first-generation motion sensor.</p>
<p>— It is not possible to use a first-generation workshop card for coupling a second-generation VU to a motion sensor.</p>
<p>13.   <strong>SECURITY FOR REMOTE COMMUNICATION OVER DSRC</strong>
            </p>
<p>13.1.   <strong>General</strong>
            </p>
<p>As specified in Appendix 14, a VU regularly generates Remote Tachograph Monitoring (RTM) data and sends this data to the (internal or external) Remote Communication Facility (RCF). The remote communication facility is responsible for sending this data over the DSRC interface described in Appendix 14 to the remote interrogator. Appendix 1 specifies that the RTM data is the concatenation of:</p>
<p>
               <strong>Encrypted tachograph payload</strong>the encryption of the plaintext tachograph payload</p>
<p>
               <strong>DSRC security data</strong>described below</p>
<p>The plaintext tachograph payload data format is specified in Appendix 1 and further described in Appendix 14. This section describes the structure of the DSRC security data; the formal specification is in Appendix 1.</p>
<p>CSM_223 The plaintext data communicated by a VU to a Remote Communication Facility (if the RCF is external to the VU) or from the VU to a remote interrogator over the DSRC interface (if the RCF is internal in the VU) shall be protected in encrypt-then-authenticate mode, i.e. the tachograph payload data is encrypted first to ensure message confidentiality, and afterwards a MAC is calculated to ensure data authenticity and integrity.</p>
<p>CSM_224 The DSRC security data shall consist of the concatenation of the following data elements in the following order; see also Figure 12:</p>
<table>
               <tbody><tr>
                  <td>Current date time</td>
                  <td>the current date and time of the VU (data type )</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>Counter</td>
                  <td>a 3-byte counter, see CSM_225</td>
               </tr>
            </tbody></table>
<p>▼M1</p>
<table>
               <tbody><tr>
                  <td>VU serial number</td>
                  <td>the VU’s serial number or certificate request ID (data type VuSerialNumber or CertificateRequestID) – see CSM_123</td>
               </tr>
            </tbody></table>
<p>▼B</p>
<table>
               <tbody><tr>
                  <td>DSRC master key version number</td>
                  <td>the 1-byte version number of the DSRC master key from which the VU-specific DSRC keys were derived, see section 9.2.2.</td>
               </tr>
            </tbody></table>
<table>
               <tbody><tr>
                  <td>MAC</td>
                  <td>the MAC calculated over all previous bytes in the RTM data.</td>
               </tr>
            </tbody></table>
<p>CSM_225 The 3-byte counter in the DSRC security data shall be in MSB-first format. The first time a VU calculates a set of RTM data after it is taken into production, it shall set the value of the counter to 0. The VU shall increase the value of the counter data by 1, each time before it calculates a next set of RTM data.</p>
<p>13.2.   <strong>Tachograph Payload Encryption and MAC Generation</strong>
            </p>
<p>CSM_226 Given a plaintext data element with data type  as described in Appendix 14, a VU shall encrypt this data as shown in Figure 12: the VU&#39;s DSRC key for encryption K_VU<span>DSRC</span>_ENC (see section 9.2.2) shall be used with AES in the Cipher Block Chaining (CBC) mode of operation, as defined in [ISO 10116], with an interleave parameter <em>m</em> = 1. The initialization vector shall be equal to <em>IV</em> = <em>current date time</em> || ‘<em>00 00 00 00 00 00 00 00 00</em>’ || <em>counter</em>, where <em>current date time</em> and <em>counter</em> are specified in CSM_224. The data to be encrypted shall be padded using method 2 defined in [ISO 9797-1].</p>
<p>CSM_227 A VU shall calculate the MAC in the DSRC security data as shown in Figure 12: the MAC shall be calculated over all preceding bytes in the RTM data, up to and including the DSRC master key version number, and including the tags and lengths of the data objects. The VU shall use its DSRC key for authenticity K_VU<span>DSRC</span>_MAC (see section 9.2.2) with the AES algorithm in CMAC mode as specified in [SP 800-38B]. The length of the MAC shall be linked to the length of the VU-specific DSRC keys, as specified in CSM_50.</p>
<p>
               <em>Figure 12</em>
            </p>
<p>
               <strong>Tachograph payload encryption and MAC generation</strong>
            </p>
<p>13.3.   <strong>Verification and Decryption of Tachograph Payload</strong>
            </p>
<p>CSM_228 When a remote interrogator receives RTM data from a VU, it shall send the entire RTM data to a control card in the data field of a PROCESS DSRC MESSAGE command, as described in Appendix 2. Then:</p>
<dl><dt>1.</dt><dd>The control card shall inspect the DSRC master key version number in the DSRC security data. If the control card does not know the indicated DSRC master key, it shall return an error specified in Appendix 2 and abort the process.</dd></dl>
<p>▼M1</p>
<dl><dt>2.</dt><dd>The control card shall use the indicated DSRC master key in combination with the VU serial number or the certificate request ID in the DSRC security data to derive the VU-specific DSRC keys K_VUDSRC_ENC and K_VUDSRC_MAC, as specified in CSM_124.</dd></dl>
<p>▼B</p>
<dl><dt>3.</dt><dd>The control card shall use K_VUDSRC_MAC to verify the MAC in the DSRC security data, as specified in CSM_227. If the MAC is incorrect, the control card shall return an error specified in Appendix 2 and abort the process.</dd><dt>4.</dt><dd>The control card shall use K_VUDSRC_ENC to decrypt the encrypted tachograph payload, as specified in CSM_226. The control card shall remove the padding and shall return the decrypted tachograph payload data to the remote interrogator.</dd></dl>

<p>CSM_229 In order to prevent replay attacks, the remote interrogator shall verify the freshness of the RTM data by verifying that the <em>current date time</em> in the DSRC security data does not deviate too much from the current time of the remote interrogator.</p>
<p>
               <em>Notes:</em>
            </p>
<p>— This requires the remote interrogator to have an accurate and reliable source of time.</p>
<p>— Since Appendix 14 requires a VU to calculate a new set of RTM data every 60 seconds, and the clock of the VU is allowed to deviate 1 minute from the real time, a lower limit for the freshness of the RTM data is 2 minutes. The actual freshness to be required also depends on the accuracy of the clock of the remote interrogator.</p>
<p>CSM_230 When a workshop verifies the correct functioning of the DSRC functionality of a VU, it shall send the entire RTM data received from the VU to a workshop card in the data field of a PROCESS DSRC MESSAGE command, as described in Appendix 2. The workshop card shall perform all checks and actions specified in CSM_228.</p>
<p>14.   <strong>SIGNING DATA DOWNLOADS AND VERIFYING SIGNATURES</strong>
            </p>
<p>14.1.   <strong>General</strong>
            </p>
<p>CSM_231 The Intelligent Dedicated Equipment (IDE) shall store data received from a VU or a card during one download session within one physical data file. Data may be stored on an ESM (external storage medium). This file contains digital signatures over data blocks, as specified in Appendix 7. This file shall also contain the following certificates (refer to section 9.1):</p>
<dl><dt>—  —  —</dt><dd>
                  <div>In case of a VU download:</div>
                  <div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>The VU_Sign certificate</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>The MSCA_VU-EGF certificate containing the public key to be used for verification of the VU_Sign certificate</div>
                        </div>
                     </div>
                  </div>
               </dd><dt>—  —  —</dt><dd>
                  <div>In case of a Card download:</div>
                  <div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>The Card_Sign certificate</div>
                        </div>
                     </div>
                     <div>
                        <div>—</div>
                        <div>
                           <div>The MSCA_Card certificate containing the public key to be used for verification of the Card_Sign certificate</div>
                        </div>
                     </div>
                  </div>
               </dd></dl>

<p>CSM_232 The IDE shall also dispose of.</p>
<dl><dt>—</dt><dd>In case it uses a control card to verify the signature, as shown in Figure 13: The link certificate linking the latest EUR certificate to the EUR certificate whose validity period directly precedes it, if existing.</dd><dt>—</dt><dd>In case it verifies the signature itself: all valid European root certificates.</dd></dl>

<p>
               <em>Note:</em> the method the IDE uses to retrieve these certificates is not specified in this Appendix.</p>
<p>14.2.   <strong>Signature generation</strong>
            </p>
<p>CSM_233 The signing algorithm to create digital signatures over downloaded data shall be ECDSA as specified in [DSS], using the hashing algorithm linked to the key size of the VU or the card, as specified in CSM_50. The signature format shall be plain, as specified in [TR-03111].</p>
<p>14.3.   <strong>Signature verification</strong>
            </p>
<p>CSM_234  ►M1  An IDE may perform verification of a signature over downloaded data itself or it may use a control card for this purpose. In case it uses a control card, signature verification shall take place as shown in Figure 13. For verifying the temporal validity of a certificate presented by the IDE, the control card shall use its internal current time, as specified in CSM_167. The control card shall update its current time if the Effective Date of an authentic ‘valid source of time’ certificate is more recent than the card’s current time. The card shall accept only the following certificates as a valid source of time:</p>
<dl><dt>—</dt><dd>Second-generation ERCA link certificates</dd><dt>—</dt><dd>Second-generation MSCA certificates</dd><dt>—</dt><dd>Second-generation VU_Sign or Card_Sign certificates issued by the same country as the control card’s own card certificate.</dd></dl>


<p>In case it performs signature verification itself, the IDE shall verify the authenticity and validity of all certificates in the certificate chain in the data file, and it shall verify the signature over the data following the signature scheme defined in [DSS]. In both cases, for every certificate read from the data file, it is necessary to verify that the Certificate Holder Authorisation (CHA) field is correct:</p>
<dl><dt>—</dt><dd>The CHA field of the EQT certificate shall indicate a VU or Card (as applicable) certificate for signing (see Appendix 1, data type EquipmentType).</dd><dt>—</dt><dd>The CHA of the EQT.CA certificate shall indicate an MSCA.</dd><dt>—</dt><dd>The CHA of the EQT.Link certificate shall indicate the ERCA. ◄</dd></dl>


<p>
               <em>Notes to Figure 13:</em>
            </p>
<p>— The equipment that signed the data to be analysed is denoted EQT.</p>
<p>— The EQT certificates and public keys mentioned in the figure are those for signing, i.e. VU_Sign or Card_Sign.</p>
<p>— The EQT.CA certificates and public keys mentioned in the figure are those for signing VU or Card certificates, as applicable.</p>
<p>— The EQT.CA.EUR certificate mentioned in the figure is the European root certificate that is indicated in the CAR of the EQT.CA certificate.</p>
<p>— The EQT.Link certificate mentioned in the figure is the EQT&#39;s link certificate, if present. As specified in section 9.1.2, this is a link certificate for a new European root key pair created by the ERCA and signed with the previous European private key.</p>
<p>— The EQT.Link.EUR certificate is the European root certificate that is indicated in the CAR of the EQT.Link certificate.</p>
<p>CSM_235 For calculating the hash M sent to the control card in the PSO:Hash command, the IDE shall use the hashing algorithm linked to the key size of the VU or the card from which the data is downloaded, as specified in CSM_50.</p>
<p>CSM_236 For verifying the EQT&#39;s signature, the control card shall follow the signature scheme defined in [DSS].</p>
<p>
               <em>Note:</em> This document does not specify any action to undertake if a signature over a downloaded data file cannot be verified or if the verification is unsuccessful.</p>
<p>▼M1</p>
<p>
               <em>Figure 13</em>
            </p>
<p>
               <strong>Protocol for verification of the signature over a downloaded data file</strong>
            </p>

<p>▼B</p>

</body></html>